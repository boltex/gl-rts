(()=>{"use strict";var e,t,i,n={ZOOM:{MIN:.5,MAX:2,STEPS:4,FACTOR:Math.pow(2,1/4)},SCROLL:{BORDER:12,DEFAULT_KEYBOARD_SPEED:3,KEYBOARD_SPEEDS:[{label:"Slowest",value:25},{label:"Slower",value:45},{label:"Slow",value:65},{label:"Normal",value:85},{label:"Fast",value:115},{label:"Faster",value:145},{label:"Fastest",value:175}],DEFAULT_SCROLL_SPEED:3,SCROLL_SPEEDS:[{label:"Slowest",value:25},{label:"Slower",value:45},{label:"Slow",value:65},{label:"Normal",value:85},{label:"Fast",value:115},{label:"Faster",value:145},{label:"Fastest",value:175}],DEFAULT_DRAG_INVERT:!1,DEFAULT_DRAG_SPEED:3,DRAG_SPEEDS:[{label:"Slowest",value:1},{label:"Slower",value:2},{label:"Slow",value:4},{label:"Normal",value:8},{label:"Fast",value:16},{label:"Faster",value:32},{label:"Fastest",value:64}]}},a={AUDIO:{DEFAULT_MUSIC_ENABLED:!0,DEFAULT_SOUND_ENABLED:!0,DEFAULT_MUSIC_VOLUME:50,DEFAULT_SOUND_VOLUME:50},SHORTCUT_KEYS:[{key:"F1",action:"Help menu"},{key:"F6",action:"Reset zoom"},{key:"F10",action:"Options menu"},{key:"Ctrl+Alt+F",action:"Toggle FPS display"},{key:"Ctrl+M",action:"Toggle music"},{key:"Ctrl+S",action:"Toggle sound"},{key:"Tab",action:"Toggle minimap terrain"},{key:"+ or -",action:"Change game speed"}],EDITOR_KEYS:[{key:"F9",action:"Toggle editor-mode"},{key:"+ or -",action:"Change map tile"},{key:"Spacebar",action:"Play / Pause animation"},{key:"A or D",action:"Change orientation"},{key:"← or →",action:"Change selected frame"},{key:"↑ or ↓",action:"Change current sprite"}],TEXTURE_MODEL_DATA:new Float32Array([1,0,1,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,0,1,0,1]),RECTANGLE_MODEL_DATA:new Float32Array([1,0,0,1,1,1,1,0,0,0,0,1]),DISPLAY:{DEFAULT_RESOLUTION:0,RESOLUTIONS:[{label:"16:9",width:1920,height:1080},{label:"16:10",width:1920,height:1200},{label:"4:3",width:1440,height:1080}]},GAME:{ACTIONS:{DEFAULT:1,RELEASESEL:2},TILE:{SIZE:128,DEPTH:64},FONT:{SIZE:32,DEPTH:95,MAX:256},WIDGETS:{SIZE:128,DEPTH:5,MAX:100},RECTANGLES:{MAX:256},SPRITES:{BITMAP_SIZE:4096,SIZE:64},MAP:{WIDTH:64,HEIGHT:64},TIMING:{FPS_UPDATE_INTERVAL:1e3,CHECK_UPDATE_INTERVAL:250,CONSTANT_TIME_PER_ANIM:67,DEFAULT_SPEED:3,GAME_SPEEDS:[{label:"Slowest",value:167},{label:"Slower",value:111},{label:"Slow",value:83},{label:"Normal",value:67},{label:"Fast",value:56},{label:"Faster",value:48},{label:"Fastest",value:42}]},ENTITY:{INITIAL_POOL_SIZE:100}},CAMERA:n,UI:{MINIMAP_RATIO:3.75,WIDGET:{TOTAL_FRAMES:6,ANIMATION_FRAMES:[0,2,4,3,2,1]}},FONT_SIZES:[10,10.625,12.84375,23.28125,17.46875,31.25,21.5625,6.75,12.25,12.25,17.46875,23.28125,9.6875,11.625,9.6875,12.234375,17.46875,17.46875,17.46875,17.46875,17.46875,17.46875,17.46875,17.46875,17.46875,17.46875,11.3125,11.3125,23.28125,23.28125,23.28125,15.15625,29.09375,19.1875,18.859375,19.21875,21.703125,17.953125,16.6875,21.359375,21.609375,11.9375,13.328125,18.8125,15.921875,24.65625,21.359375,22.640625,17.640625,22.640625,19.859375,17.828125,18.6875,20.984375,19.09375,28.859375,18.578125,18.4375,17.890625,12.25,12.234375,12.25,23.28125,17.46875,17.46875,16.796875,17.6875,14.765625,17.6875,16.84375,10.1875,17.6875,17.84375,7.3125,9.015625,15.9375,7.3125,26.875,17.84375,17.375,17.6875,17.6875,11.53125,14.28125,10.703125,17.84375,15.9375,23.75,15.84375,15.9375,14.21875,15.375,12.234375,15.375,23.28125]},r="#version 300 es\n\n// The next two are the repeated geometry and UV for each instance of the model\nlayout(location=0) in vec4 aPosition;\nlayout(location=1) in vec2 aTexCoord;\n\n// Those next four use vertexAttribDivisor and are updated every instance\nlayout(location=2) in vec3 aOffset;\nlayout(location=3) in float aScale;\nlayout(location=4) in vec4 aColor;\nlayout(location=5) in float aDepth;\n\nlayout(std140) uniform World {\n    float uWorldX;\n    float uWorldY;\n};\n\nout vec4 vColor;\nout vec2 vTexCoord;\nout float vDepth;\n\nvoid main()\n{\n    vColor = aColor;\n    vTexCoord = aTexCoord;\n    vDepth = aDepth;\n    vec3 pos = aPosition.xyz * aScale + aOffset;\n    \n    // This brings it in the range 0-2. So it also needs a -1 to 1 conversion.\n    gl_Position = vec4((pos.x * uWorldX) - 1.0, (pos.y * uWorldY) + 1.0, pos.z, 1.0);\n\n}",s="#version 300 es\n\nprecision mediump float;\n\nuniform mediump sampler2DArray uSampler;\n\nin vec4 vColor;\nin vec2 vTexCoord;\nin float vDepth;\nout vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vColor * texture(uSampler, vec3(vTexCoord, vDepth));\n}",o=(e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},e(t,i)},function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}),l=function(){function e(e,t,i){this.resources={buffers:[],textures:[],shaders:[]},this.gl=e,this.program=this.createProgram(t,i),this.gl.useProgram(this.program),this.vao=this.gl.createVertexArray(),this.dirtyTransforms=!1}return e.prototype.createProgram=function(e,t){var i=this.gl.createProgram(),n="",a=this.createShader(this.gl.VERTEX_SHADER,e),r=this.createShader(this.gl.FRAGMENT_SHADER,t);a&&r||(n+="\nFailed to create shaders"),this.gl.attachShader(i,a),this.gl.attachShader(i,r),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)||(n+="\nProgram linking failed: ".concat(this.gl.getProgramInfoLog(i))),this.gl.validateProgram(i),this.gl.getProgramParameter(i,this.gl.VALIDATE_STATUS)||(n+="\nProgram validation failed: ".concat(this.gl.getProgramInfoLog(i)));var s=this.gl.getProgramParameter(i,this.gl.ACTIVE_ATTRIBUTES),o=this.gl.getProgramParameter(i,this.gl.ACTIVE_UNIFORMS);if(0===s&&0===o&&(n+="\nWarning: Program has no active attributes or uniforms"),n)throw new Error("WebGL Program creation failed: ".concat(n));return i},e.prototype.createShader=function(e,t){var i=this.gl.createShader(e);if(!i)throw new Error("Failed to create shader");if(this.resources.shaders.push(i),this.gl.shaderSource(i,t),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw console.error(this.gl.getShaderInfoLog(i)),new Error("Shader compilation failed");return i},e.prototype.setupBufferWithAttributes=function(e,t,i,n){var a=this;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,i),n.forEach((function(e){var t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],o=void 0===s?0:s;a.setupAttribute(t,i,n,r,o)}))},e.prototype.createBuffer=function(){var e=this.gl.createBuffer();return this.resources.buffers.push(e),e},e.prototype.createTexture=function(){var e=this.gl.createTexture();return this.resources.textures.push(e),e},e.prototype.setupAttribute=function(e,t,i,n,a){void 0===a&&(a=0),this.gl.vertexAttribPointer(e,t,this.gl.FLOAT,!1,i,n),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribDivisor(e,a)},e.prototype.dispose=function(){var e=this;this.resources.textures.forEach((function(t){return e.gl.deleteTexture(t)})),this.resources.buffers.forEach((function(t){return e.gl.deleteBuffer(t)})),this.resources.shaders.forEach((function(t){return e.gl.deleteShader(t)})),this.gl.deleteProgram(this.program),this.gl.deleteVertexArray(this.vao),this.resources.textures=[],this.resources.buffers=[],this.resources.shaders=[]},e}(),h=function(e){function t(t,i,n){var a=e.call(this,t,r,s)||this;return a.renderMax=0,a.image=i,a.texture=a.createTexture(),a.modelBuffer=a.createBuffer(),a.transformBuffer=a.createBuffer(),a.transformData=new Float32Array(7*n),a.setupVAO(),a}return o(t,e),t.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.texImage3D(this.gl.TEXTURE_2D_ARRAY,0,this.gl.RGBA,a.GAME.TILE.SIZE,a.GAME.TILE.SIZE,a.GAME.TILE.DEPTH,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.image),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.generateMipmap(this.gl.TEXTURE_2D_ARRAY),this.setupBufferWithAttributes(this.modelBuffer,a.TEXTURE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,16,0],[1,2,16,8]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[2,2,28,0,1],[3,1,28,8,1],[4,3,28,12,1],[5,1,28,24,1]]),this.gl.bindVertexArray(null)},t.prototype.updateTransformData=function(e){void 0===e&&(e=[]);for(var t=0;t<e.length;t++){var i=7*t;this.transformData[i]=e[t][0],this.transformData[i+1]=e[t][1],this.transformData[i+2]=a.GAME.TILE.SIZE,this.transformData[i+3]=1,this.transformData[i+4]=1,this.transformData[i+5]=1,this.transformData[i+6]=e[t][2]}this.renderMax=e.length,this.dirtyTransforms=!0},t.prototype.updateTransformDataForMinimap=function(e,t){for(var i=0;i<e.length;i++){var n=7*i;this.transformData[n]=e[i][0],this.transformData[n+1]=e[i][1],this.transformData[n+2]=t,this.transformData[n+3]=1,this.transformData[n+4]=1,this.transformData[n+5]=1,this.transformData[n+6]=e[i][2]}this.renderMax=e.length,this.dirtyTransforms=!0},t.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,7*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},t}(l),d=function(e){function t(t,i,n){var a=e.call(this,t,"#version 300 es\n\n// The next two are the repeated geometry and UV for each instance of the model\nlayout(location=0) in vec4 aPosition;\nlayout(location=1) in vec2 aTexCoord;\n\n// Those next four use vertexAttribDivisor and are updated every instance\nlayout(location=2) in vec3 aOffset;\nlayout(location=3) in float aScale;\nlayout(location=4) in vec4 aColor;\nlayout(location=5) in float aDepth;\n\nlayout(std140) uniform World {\n    float uWorldX;\n    float uWorldY;\n};\n\nout vec4 vColor;\nout vec2 vTexCoord;\nout float vDepth;\n\nvoid main()\n{\n    vColor = aColor;\n    vTexCoord = aTexCoord;\n    vDepth = aDepth;\n    vec3 pos = aPosition.xyz * aScale + aOffset;\n    \n    // This brings it in the range 0-2. So it also needs a -1 to 1 conversion.\n    gl_Position = vec4((pos.x * uWorldX) - 1.0, (pos.y * uWorldY) + 1.0, pos.z, 1.0);\n\n}","#version 300 es\n\nprecision mediump float;\n\nuniform mediump sampler2DArray uSampler;\n\nin vec4 vColor;\nin vec2 vTexCoord;\nin float vDepth;\nout vec4 fragColor;\n\nvoid main()\n{\n    // Sample the texture to get the red channel (grayscale value)\n    float alpha = texture(uSampler, vec3(vTexCoord, vDepth)).r;\n    \n    // Use vColor for the RGB and the texture's red channel as alpha\n    fragColor = vec4(vColor.rgb, alpha);\n}")||this;return a.renderMax=0,a.image=i,a.texture=a.createTexture(),a.modelBuffer=a.createBuffer(),a.transformBuffer=a.createBuffer(),a.transformData=new Float32Array(7*n),a.setupVAO(),a}return o(t,e),t.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.texImage3D(this.gl.TEXTURE_2D_ARRAY,0,this.gl.R8,a.GAME.FONT.SIZE,a.GAME.FONT.SIZE,a.GAME.FONT.DEPTH,0,this.gl.RED,this.gl.UNSIGNED_BYTE,this.image),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.generateMipmap(this.gl.TEXTURE_2D_ARRAY),this.setupBufferWithAttributes(this.modelBuffer,a.TEXTURE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,16,0],[1,2,16,8]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[2,2,28,0,1],[3,1,28,8,1],[4,3,28,12,1],[5,1,28,24,1]]),this.gl.bindVertexArray(null)},t.prototype.updateTransformData=function(e){void 0===e&&(e=[]);for(var t=0;t<e.length;t++){var i=7*t;this.transformData[i]=e[t][0],this.transformData[i+1]=e[t][1],this.transformData[i+2]=e[t][3],this.transformData[i+3]=0,this.transformData[i+4]=1,this.transformData[i+5]=0,this.transformData[i+6]=e[t][2]}this.renderMax=e.length,this.dirtyTransforms=!0},t.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,7*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},t}(l),m=function(e){function t(t,i,n){var a=e.call(this,t,r,s)||this;return a.renderMax=0,a.image=i,a.texture=a.createTexture(),a.modelBuffer=a.createBuffer(),a.transformBuffer=a.createBuffer(),a.transformData=new Float32Array(7*n),a.setupVAO(),a}return o(t,e),t.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.texImage3D(this.gl.TEXTURE_2D_ARRAY,0,this.gl.RGBA,a.GAME.WIDGETS.SIZE,a.GAME.WIDGETS.SIZE,a.GAME.WIDGETS.DEPTH,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.image),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.generateMipmap(this.gl.TEXTURE_2D_ARRAY),this.setupBufferWithAttributes(this.modelBuffer,a.TEXTURE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,16,0],[1,2,16,8]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[2,2,28,0,1],[3,1,28,8,1],[4,3,28,12,1],[5,1,28,24,1]]),this.gl.bindVertexArray(null)},t.prototype.updateTransformData=function(e){void 0===e&&(e=[]);for(var t=0;t<e.length;t++){var i=7*t;this.transformData[i]=e[t][0],this.transformData[i+1]=e[t][1],this.transformData[i+2]=e[t][3],this.transformData[i+3]=1,this.transformData[i+4]=1,this.transformData[i+5]=1,this.transformData[i+6]=e[t][2]}this.renderMax=e.length,this.dirtyTransforms=!0},t.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,7*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},t}(l),u=function(e){function t(t,i,n){var a=e.call(this,t,"#version 300 es\n\n// The next two are the repeated geometry and UV for each instance of the model\nlayout(location=0) in vec4 aPosition;\nlayout(location=1) in vec2 aTexCoord;\n\n// Those next four use vertexAttribDivisor and are updated every instance\nlayout(location=2) in vec3 aOffset;\nlayout(location=3) in float aScale;\nlayout(location=4) in vec4 aColor;\nlayout(location=5) in vec2 aUV;\n\nlayout(std140) uniform World {\n    float uWorldX;\n    float uWorldY;\n};\n\nout vec4 vColor;\nout vec2 vTexCoord;\n\nvoid main()\n{\n    vColor = aColor;\n    vTexCoord = vec2(aTexCoord * 0.015625) + aUV;\n\n    vec3 pos = aPosition.xyz * aScale + aOffset;\n\n    // This brings it in the range 0-2. So it also needs a -1 to 1 conversion.\n    gl_Position = vec4((pos.x * uWorldX) - 1.0, (pos.y * uWorldY) + 1.0, pos.z, 1.0);\n\n}","#version 300 es\n\nprecision mediump float;\n\nuniform mediump sampler2D uSampler;\n\nin vec4 vColor;\nin vec2 vTexCoord;\nout vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vColor * texture(uSampler, vTexCoord);\n}")||this;return a.renderMax=0,a.image=i,a.texture=a.createTexture(),a.modelBuffer=a.createBuffer(),a.transformBuffer=a.createBuffer(),a.transformData=new Float32Array(8*n),a.setupVAO(),a}return o(t,e),t.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a.GAME.SPRITES.BITMAP_SIZE,a.GAME.SPRITES.BITMAP_SIZE,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.image),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.setupBufferWithAttributes(this.modelBuffer,a.TEXTURE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,16,0],[1,2,16,8]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[2,2,32,0,1],[3,1,32,8,1],[4,3,32,12,1],[5,2,32,24,1]]),this.gl.bindVertexArray(null)},t.prototype.updateTransformData=function(e,t){for(var i=t.scrollX,n=t.scrollY,a=t.gameScreenWidth,r=t.gameScreenHeight,s=0,o=0,l=e.length;o<l;o++){var h=e[o];if(h.active){var d=h.x,m=h.y;if(!(d+128<i||d>i+a||m+128<n||m>n+r)){var u=8*s,c=h.frameIndex,g=h.orientation,p=c%16*.015625+g%4*.25,E=.015625*Math.floor(c/16)+.25*Math.floor(g/4);this.transformData[u]=d-i,this.transformData[u+1]=m-n,this.transformData[u+2]=h.size,this.transformData[u+3]=1,this.transformData[u+4]=1,this.transformData[u+5]=1,this.transformData[u+6]=p,this.transformData[u+7]=E,s++}}}this.renderMax=s,this.dirtyTransforms=!0},t.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,8*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},t}(l),c=function(e){function t(t,i){var n=e.call(this,t,"#version 300 es\n\n// The next two are the repeated geometry and UV for each instance of the model\nlayout(location=0) in vec4 aPosition;\n\n// Those next four use vertexAttribDivisor and are updated every instance\nlayout(location=1) in vec3 aOffset;\nlayout(location=2) in float aScaleX;\nlayout(location=3) in float aScaleY;\nlayout(location=4) in vec4 aColor;\n\nlayout(std140) uniform World {\n    float uWorldX;\n    float uWorldY;\n};\n\nout vec4 vColor;\n\nvoid main()\n{\n    vColor = aColor;\n    vec3 pos = aPosition.xyz * vec3(aScaleX, aScaleY, 1.0) + aOffset;\n    \n    // This brings it in the range 0-2. So it also needs a -1 to 1 conversion.\n    gl_Position = vec4((pos.x * uWorldX) - 1.0, (pos.y * uWorldY) + 1.0, pos.z, 1.0);\n\n}","#version 300 es\n\nprecision mediump float;\n\nin vec4 vColor;\nout vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vColor;\n}")||this;return n.renderMax=0,n.modelBuffer=n.createBuffer(),n.transformBuffer=n.createBuffer(),n.transformData=new Float32Array(8*i),n.setupVAO(),n}return o(t,e),t.prototype.updateTransformData=function(e){for(var t=0;t<e.length;t++){var i=8*t;this.transformData[i]=e[t].x,this.transformData[i+1]=e[t].y,this.transformData[i+2]=e[t].width,this.transformData[i+3]=e[t].height,this.transformData[i+4]=e[t].r,this.transformData[i+5]=e[t].g,this.transformData[i+6]=e[t].b,this.transformData[i+7]=e[t].a}this.renderMax=e.length,this.dirtyTransforms=!0},t.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.setupBufferWithAttributes(this.modelBuffer,a.RECTANGLE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,8,0]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[1,2,32,0,1],[2,1,32,8,1],[3,1,32,12,1],[4,4,32,16,1]]),this.gl.bindVertexArray(null)},t.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,8*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},t}(l),g=function(e){function t(t,i){var n=e.call(this,t,"#version 300 es\nlayout(location=0) in vec4 aPosition;\nlayout(location=1) in vec2 aTexCoord;\nlayout(location=2) in vec3 aOffset;\nlayout(location=3) in float aScale;\nlayout(location=4) in vec4 aColor;\nlayout(location=5) in float aDepth;\n\nlayout(std140) uniform World {\n    float uWorldX;\n    float uWorldY;\n};\n\nout vec4 vColor;\nout vec2 vTexCoord;\n\nvoid main()\n{\n    vColor = aColor;\n    vTexCoord = vec2(aTexCoord.x, 1.0 - aTexCoord.y); // Flip Y coordinate\n    vec3 pos = aPosition.xyz * aScale + aOffset;\n\n    // This brings it in the range 0-2. So it also needs a -1 to 1 conversion.\n    gl_Position = vec4((pos.x * uWorldX) - 1.0, (pos.y * uWorldY) + 1.0, pos.z, 1.0);\n}","#version 300 es\nprecision mediump float;\n\nuniform sampler2D uSampler;\n\nin vec4 vColor;\nin vec2 vTexCoord;\nout vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vColor * texture(uSampler, vTexCoord);\n}")||this;return n.minimapSize=i,n.minimapTexture=n.createTexture(),n.modelBuffer=n.createBuffer(),n.transformBuffer=n.createBuffer(),n.transformData=new Float32Array(7),n.fbo=n.createFBO(),n.setupVAO(),n}return o(t,e),t.prototype.createFBO=function(){var e=this.gl.createFramebuffer();if(!e)throw new Error("Failed to create framebuffer");if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.bindTexture(this.gl.TEXTURE_2D,this.minimapTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.minimapSize,this.minimapSize,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.minimapTexture,0),this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!==this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete");return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,null),e},t.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.setupBufferWithAttributes(this.modelBuffer,a.TEXTURE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,16,0],[1,2,16,8]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[2,2,28,0,1],[3,1,28,8,1],[4,3,28,12,1],[5,1,28,24,1]]),this.gl.bindVertexArray(null)},t.prototype.renderMapToTexture=function(e,t,i){var n=this.gl.getParameter(this.gl.VIEWPORT);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo),this.gl.viewport(0,0,this.minimapSize,this.minimapSize),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),i){for(var r=a.GAME.MAP.WIDTH,s=a.GAME.MAP.HEIGHT,o=this.minimapSize/Math.max(r,s),l=[],h=0;h<s;h++)for(var d=0;d<r;d++){var m=t[d+h*r];l.push([d*o,h*o,m])}e.updateTransformDataForMinimap(l,o),e.render()}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(n[0],n[1],n[2],n[3]),this.gl.bindTexture(this.gl.TEXTURE_2D,null)},t.prototype.updateTransformData=function(e,t){var i=10/t.zoom,n=Math.min(t.gameScreenWidth,t.gameScreenHeight)/a.UI.MINIMAP_RATIO;this.transformData[0]=i,this.transformData[1]=t.gameScreenHeight-n-i,this.transformData[2]=n,this.transformData[3]=1,this.transformData[4]=1,this.transformData[5]=1,this.transformData[6]=0,this.dirtyTransforms=!0},t.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D,this.minimapTexture),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,1)},t.prototype.renderUnitMarkers=function(e){},t.prototype.dispose=function(){e.prototype.dispose.call(this),this.gl.deleteFramebuffer(this.fbo)},t}(l),p=function(){function e(e,t,i,n,r){this.minimapSize=256,this.terrainVisible=!0,this.gl=e,this.tileRenderer=new h(this.gl,t,a.GAME.MAP.WIDTH*a.GAME.MAP.HEIGHT),this.widgetRenderer=new m(this.gl,n,a.GAME.WIDGETS.MAX),this.spriteRenderer=new u(this.gl,i,a.GAME.ENTITY.INITIAL_POOL_SIZE),this.rectangleRenderer=new c(this.gl,a.GAME.RECTANGLES.MAX),this.fontRenderer=new d(this.gl,r,a.GAME.FONT.MAX),this.minimapRenderer=new g(this.gl,this.minimapSize),this.worldBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.UNIFORM_BUFFER,this.worldBuffer),this.gl.bufferData(this.gl.UNIFORM_BUFFER,16,this.gl.DYNAMIC_DRAW),this.initUboBindings(),this.worldData=new Float32Array(2)}return e.prototype.toggleTerrain=function(){this.terrainVisible=!this.terrainVisible},e.prototype.initUboBindings=function(){for(var t=0,i=[this.tileRenderer.program,this.widgetRenderer.program,this.spriteRenderer.program,this.rectangleRenderer.program].filter((function(e){return null!=e}));t<i.length;t++){var n=i[t],a=this.gl.getUniformBlockIndex(n,"World");this.gl.uniformBlockBinding(n,a,e.WORLD_BINDING_POINT)}this.gl.bindBufferBase(this.gl.UNIFORM_BUFFER,e.WORLD_BINDING_POINT,this.worldBuffer)},e.prototype.setUboWorldTransforms=function(e,t){this.worldData[0]=2/e,this.worldData[1]=2/-t,this.gl.bindBuffer(this.gl.UNIFORM_BUFFER,this.worldBuffer),this.gl.bufferSubData(this.gl.UNIFORM_BUFFER,0,this.worldData)},e.prototype.render=function(e,t,i,n,a,r,s,o,l,h){this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),h&&(this.setUboWorldTransforms(this.minimapSize,this.minimapSize),this.minimapRenderer.renderMapToTexture(this.tileRenderer,l,this.terrainVisible),this.setUboWorldTransforms(s.gameScreenWidth,s.gameScreenHeight)),e.length&&this.tileRenderer.updateTransformData(e),this.tileRenderer.render(),this.spriteRenderer.updateTransformData(t,s),this.spriteRenderer.render(),i.length&&(this.rectangleRenderer.updateTransformData(i),this.rectangleRenderer.render()),a.length&&(this.widgetRenderer.updateTransformData(a),this.widgetRenderer.render()),r.length&&(this.fontRenderer.updateTransformData(r),this.fontRenderer.render()),this.minimapRenderer.updateTransformData([],s),this.minimapRenderer.render(),n.length&&(this.rectangleRenderer.updateTransformData(n),this.rectangleRenderer.render()),this.gl.flush()},e.prototype.dispose=function(){this.tileRenderer.dispose(),this.spriteRenderer.dispose(),this.rectangleRenderer.dispose(),this.widgetRenderer.dispose(),this.minimapRenderer.dispose()},e.WORLD_BINDING_POINT=0,e}(),E=function(){function e(e){this.invertDrag=!1,this.keysPressed={},this.selecting=!1,this.minimapDragging=!1,this.dragScrolling=!1,this.borderScrolling=!1,this.mouseInScreen=!0,this.mouseX=0,this.mouseY=0,this.gameMouseX=0,this.gameMouseY=0,this.selX=0,this.selY=0,this.gameSelStartX=0,this.gameSelStartY=0,this.gameSelEndX=0,this.gameSelEndY=0,this.scrollNowX=0,this.scrollNowY=0,this.lastMouseX=0,this.lastMouseY=0,this.keyboardUp=!1,this.keyboardDown=!1,this.keyboardLeft=!1,this.keyboardRight=!1,this.keyDownHandler=this.handleKeyDown.bind(this),this.keyUpHandler=this.handleKeyUp.bind(this),this.mouseEnterHandler=this.handleMouseEnter.bind(this),this.mouseLeaveHandler=this.handleMouseLeave.bind(this),this.mouseMoveHandler=this.handleMouseMove.bind(this),this.mouseDownHandler=this.handleMouseDown.bind(this),this.mouseUpHandler=this.handleMouseUp.bind(this),this.mouseWheelHandler=this.handleMouseWheel.bind(this),this.game=e,this.keyboardSpeed=a.CAMERA.SCROLL.KEYBOARD_SPEEDS[a.CAMERA.SCROLL.DEFAULT_KEYBOARD_SPEED].value,this.scrollSpeed=a.CAMERA.SCROLL.SCROLL_SPEEDS[a.CAMERA.SCROLL.DEFAULT_SCROLL_SPEED].value,this.dragSpeed=a.CAMERA.SCROLL.DRAG_SPEEDS[a.CAMERA.SCROLL.DEFAULT_DRAG_SPEED].value,this.invertDrag=a.CAMERA.SCROLL.DEFAULT_DRAG_INVERT}return e.prototype.setKeyboardSpeed=function(e){this.keyboardSpeed=e},e.prototype.setScrollSpeed=function(e){this.scrollSpeed=e},e.prototype.setDragSpeed=function(e,t){this.dragSpeed=e,this.invertDrag=t},Object.defineProperty(e.prototype,"gamePosition",{get:function(){return{x:this.gameMouseX,y:this.gameMouseY}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selectionStart",{get:function(){return{x:this.gameSelStartX,y:this.gameSelStartY}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selectionEnd",{get:function(){return{x:this.gameSelEndX,y:this.gameSelEndY}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scrollVelocity",{get:function(){return{dx:this.scrollNowX,dy:this.scrollNowY}},enumerable:!1,configurable:!0}),e.prototype.init=function(){window.addEventListener("keydown",this.keyDownHandler),window.addEventListener("keyup",this.keyUpHandler),document.documentElement.addEventListener("mouseenter",this.mouseEnterHandler),document.documentElement.addEventListener("mouseleave",this.mouseLeaveHandler),window.addEventListener("mousemove",this.mouseMoveHandler),window.addEventListener("mousedown",this.mouseDownHandler),window.addEventListener("mouseup",this.mouseUpHandler),window.addEventListener("wheel",this.mouseWheelHandler,{passive:!1})},e.prototype.dispose=function(){window.removeEventListener("keydown",this.keyDownHandler),window.removeEventListener("keyup",this.keyUpHandler),document.documentElement.removeEventListener("mouseenter",this.mouseEnterHandler),document.documentElement.removeEventListener("mouseleave",this.mouseLeaveHandler),window.removeEventListener("mousemove",this.mouseMoveHandler),window.removeEventListener("mousedown",this.mouseDownHandler),window.removeEventListener("mouseup",this.mouseUpHandler),window.removeEventListener("wheel",this.mouseWheelHandler)},e.prototype.handleKeyDown=function(e){if(this.game.editorManager.isMapEditorOpen){if("map"===this.game.editorManager.editorMode){if("NumPad+"===e.key||"+"===e.key||!e.shiftKey&&"="===e.key)return e.preventDefault(),void this.game.editorManager.incrementMapTile();if("NumPad-"===e.key||"-"===e.key||"_"===e.key)return e.preventDefault(),void this.game.editorManager.decrementMapTile()}if(!e.ctrlKey||"s"!==e.key&&"o"!==e.key||e.preventDefault(),"animation"===this.game.editorManager.editorMode){if(" "===e.key)return e.preventDefault(),void this.game.editorManager.toggleAnimationPlayPause();if("a"===e.key||"d"===e.key)return e.preventDefault(),void this.game.editorManager.rotatePreview("a"===e.key?-1:1);if("ArrowLeft"===e.key||"ArrowRight"===e.key)return e.preventDefault(),void this.game.editorManager.changeSelectedFrame("ArrowLeft"===e.key?-1:1);if("ArrowUp"===e.key||"ArrowDown"===e.key)return e.preventDefault(),void this.game.editorManager.changeSpriteNumber("ArrowUp"===e.key?1:-1)}}else if(!this.game.optionsMenuManager.isMenuOpen){if("NumPad+"===e.key||"+"===e.key||!e.shiftKey&&"="===e.key)return e.preventDefault(),void this.game.incrementGameSpeed();if("NumPad-"===e.key||"-"===e.key||"_"===e.key)return e.preventDefault(),void this.game.decrementGameSpeed()}if(this.game.started){if("F1"===e.key){if(e.preventDefault(),this.game.optionsMenuManager.isMenuOpen||this.game.editorManager.isMapEditorOpen)return;return void this.game.helpMenuManager.toggleHelp()}if("F5"===e.key||e.ctrlKey&&"r"===e.key)return void e.preventDefault();if("F9"===e.key){if(e.preventDefault(),this.game.optionsMenuManager.isMenuOpen||this.game.helpMenuManager.isHelpMenuOpen)return;return this.selecting=!1,this.dragScrolling=!1,void this.game.editorManager.toggleMapEditor()}if("F10"===e.key){if(e.preventDefault(),this.game.optionsMenuManager.isMenuOpen||this.game.helpMenuManager.isHelpMenuOpen)return;return this.selecting=!1,this.dragScrolling=!1,void this.game.optionsMenuManager.toggleMenu()}if("F6"===e.key)return e.preventDefault(),void(this.game.optionsMenuManager.isMenuOpen||this.game.cameraManager.resetZoom());if("Escape"===e.key){if(e.preventDefault(),this.game.optionsMenuManager.isMenuOpen)return void this.game.optionsMenuManager.cancelMenu();if(this.game.helpMenuManager.isHelpMenuOpen)return void this.game.helpMenuManager.toggleHelp()}if(e.ctrlKey&&e.altKey&&"f"===e.key)return e.preventDefault(),void this.game.toggleShowFPS();if(e.ctrlKey&&"m"===e.key)return e.preventDefault(),void this.game.toggleMusic();if(e.ctrlKey&&"s"===e.key)return e.preventDefault(),void this.game.toggleSound();if(e.ctrlKey&&"o"===e.key&&e.preventDefault(),"Tab"===e.key)return e.preventDefault(),void this.game.toggleTerrain()}this.keysPressed[e.key]=!0,!e.ctrlKey||"+"!==e.key&&"-"!==e.key&&"="!==e.key&&"_"!==e.key||e.preventDefault()},e.prototype.handleKeyUp=function(e){this.keysPressed[e.key]=!1},e.prototype.handleMouseEnter=function(e){this.mouseInScreen=!0},e.prototype.handleMouseLeave=function(e){this.mouseInScreen=!1},e.prototype.handleMouseMove=function(e){if(this.game.started&&!this.game.optionsMenuManager.isMenuOpen&&!this.game.helpMenuManager.isHelpMenuOpen){if(this.dragScrolling){var t=this.lastMouseX-e.clientX,i=this.lastMouseY-e.clientY;this.invertDrag||(t=-t,i=-i),this.scrollNowX=this.dragSpeed*t*(this.game.cameraManager.gameScreenWidth/this.game.canvasBoundingRect.width),this.scrollNowY=this.dragSpeed*i*(this.game.cameraManager.gameScreenHeight/this.game.canvasBoundingRect.height);var n="cur-none";if(0!==this.scrollNowX||0!==this.scrollNowY){var a=180*Math.atan2(this.scrollNowY,this.scrollNowX)/Math.PI;a<0&&(a+=360),a>=337.5||a<22.5?n="cur-scroll-right":a>=22.5&&a<67.5?n="cur-scroll-bottom-right":a>=67.5&&a<112.5?n="cur-scroll-bottom":a>=112.5&&a<157.5?n="cur-scroll-bottom-left":a>=157.5&&a<202.5?n="cur-scroll-left":a>=202.5&&a<247.5?n="cur-scroll-top-left":a>=247.5&&a<292.5?n="cur-scroll-top":a>=292.5&&a<337.5&&(n="cur-scroll-top-right")}this.game.cursorManager.setCursor(n)}this.setCursorPos(e),this.minimapDragging&&this.handleMinimapInteraction()||this.game.editorManager.isMapEditorOpen&&this.handleMapEditorInteraction(e)||this.applyMouseScroll()}},e.prototype.handleMinimapInteraction=function(){var e=this.game.cameraManager,t=10/e.zoom,i=Math.min(e.gameScreenWidth,e.gameScreenHeight)/a.UI.MINIMAP_RATIO,n=t,r=e.gameScreenHeight-i-t;if(this.minimapDragging||this.mouseX>=n&&this.mouseX<=n+i&&this.mouseY>=r&&this.mouseY<=r+i){var s=a.GAME.MAP.WIDTH*a.GAME.TILE.SIZE,o=a.GAME.MAP.HEIGHT*a.GAME.TILE.SIZE,l=(Math.min(Math.max(this.mouseX,n),n+i)-n)/i*s,h=(Math.min(Math.max(this.mouseY,r),r+i)-r)/i*o;return e.scrollX=l-e.gameScreenWidth/2,e.scrollY=h-e.gameScreenHeight/2,e.scroll(),this.minimapDragging=!0,!0}return!1},e.prototype.handleMapEditorInteraction=function(e){if(e.target!==this.game.canvasElement)return!1;var t="mousedown"===e.type?0===e.button:1===e.buttons,i="mousedown"===e.type?2===e.button:2===e.buttons;if(t){var n=this.game.editorManager.getSelectedTileIndex();return this.game.setTileAt(this.gameMouseX,this.gameMouseY,n),!0}return!!i&&(this.game.sampleTileAt(this.gameMouseX,this.gameMouseY),!0)},e.prototype.applyMouseScroll=function(){if(!this.selecting){this.dragScrolling||(this.scrollNowX=0,this.scrollNowY=0);var e=this.game.timeManager.fps||1,t=void 0,i=this.game.cameraManager,n=this.scrollSpeed*(30/e);this.mouseY>i.scrollEdgeYMax&&i.scrollY<i.maxScrollY?(this.scrollNowY=n,t="cur-scroll-bottom"):this.mouseY<i.scrollEdgeYMin&&i.scrollY>0&&(this.scrollNowY=-n,t="cur-scroll-top"),this.mouseX>i.scrollEdgeXMax&&i.scrollX<i.maxScrollX?(this.scrollNowX=n,t?t+="-right":t="cur-scroll-right"):this.mouseX<i.scrollEdgeXMin&&i.scrollX>0&&(this.scrollNowX=-n,t?t+="-left":t="cur-scroll-left"),t?(this.borderScrolling=!0,this.game.cursorManager.setCursor(t)):(this.dragScrolling||this.game.cursorManager.setCursor("cur-pointer"),this.borderScrolling=!1)}},e.prototype.handleMouseDown=function(e){if(this.setCursorPos(e),this.game.started&&!this.game.optionsMenuManager.isMenuOpen&&!this.game.helpMenuManager.isHelpMenuOpen)if(1===e.button&&(this.dragScrolling||(this.dragScrolling=!0,this.game.cursorManager.setCursor("cur-none"))),this.game.editorManager.isMapEditorOpen)this.handleMapEditorInteraction(e);else if(!this.selecting){if(0===e.button){if(this.handleMinimapInteraction())return;this.selecting=!0,this.selX=this.mouseX,this.selY=this.mouseY,this.gameSelStartX=this.selX+this.game.cameraManager.scrollX,this.gameSelStartY=this.selY+this.game.cameraManager.scrollY,this.game.cursorManager.setCursor("cur-target")}2===e.button&&(this.game.gameAction=a.GAME.ACTIONS.DEFAULT)}},e.prototype.handleMouseUp=function(e){this.setCursorPos(e),!this.game.started||this.game.optionsMenuManager.isMenuOpen||this.game.helpMenuManager.isHelpMenuOpen||(1===e.button&&(this.dragScrolling=!1,this.selecting?this.game.cursorManager.setCursor("cur-target"):this.game.cursorManager.setCursor("cur-pointer")),this.game.editorManager.isMapEditorOpen||0===e.button&&(this.minimapDragging=!1,this.gameSelEndX=this.mouseX+this.game.cameraManager.scrollX,this.gameSelEndY=this.mouseY+this.game.cameraManager.scrollY,this.selecting=!1,this.game.gameAction=a.GAME.ACTIONS.RELEASESEL,this.dragScrolling?this.game.cursorManager.setCursor("cur-none"):this.game.cursorManager.setCursor("cur-pointer")))},e.prototype.handleMouseWheel=function(e){e.ctrlKey&&(e.preventDefault(),e.stopImmediatePropagation()),!this.game.started||this.selecting||this.game.optionsMenuManager.isMenuOpen||this.game.helpMenuManager.isHelpMenuOpen||(e.deltaY<0?this.game.cameraManager.zoomIn():e.deltaY>0&&this.game.cameraManager.zoomOut())},e.prototype.setCursorPos=function(e){var t,i;e?(t=e.clientX,i=e.clientY,this.lastMouseX=t,this.lastMouseY=i):(t=this.lastMouseX,i=this.lastMouseY),this.mouseX=t*(this.game.cameraManager.gameScreenWidth/this.game.canvasBoundingRect.width),this.mouseY=i*(this.game.cameraManager.gameScreenHeight/this.game.canvasBoundingRect.height),this.gameMouseX=this.mouseX+this.game.cameraManager.scrollX,this.gameMouseY=this.mouseY+this.game.cameraManager.scrollY},e.prototype.processInputs=function(){if(!this.game.optionsMenuManager.isMenuOpen&&!this.game.helpMenuManager.isHelpMenuOpen){var e=this.game.timeManager.fps||1;this.keysPressed.ArrowUp||this.keysPressed.w?(this.scrollNowY=-this.keyboardSpeed*(30/e),this.keyboardUp=!0):this.keyboardUp&&(this.keyboardUp=!1,this.scrollNowY=0,this.applyMouseScroll()),this.keysPressed.ArrowDown||this.keysPressed.s?(this.scrollNowY=this.keyboardSpeed*(30/e),this.keyboardDown=!0):this.keyboardDown&&(this.keyboardDown=!1,this.scrollNowY=0,this.applyMouseScroll()),this.keysPressed.ArrowLeft||this.keysPressed.a?(this.scrollNowX=-this.keyboardSpeed*(30/e),this.keyboardLeft=!0):this.keyboardLeft&&(this.keyboardLeft=!1,this.scrollNowX=0,this.applyMouseScroll()),this.keysPressed.ArrowRight||this.keysPressed.d?(this.scrollNowX=this.keyboardSpeed*(30/e),this.keyboardRight=!0):this.keyboardRight&&(this.keyboardRight=!1,this.scrollNowX=0,this.applyMouseScroll()),!this.selecting&&this.mouseInScreen&&(this.game.cameraManager.scroll(this.scrollVelocity),this.dragScrolling&&!this.borderScrolling&&(this.scrollNowX=0,this.scrollNowY=0))}},Object.defineProperty(e.prototype,"isSelecting",{get:function(){return this.selecting},enumerable:!1,configurable:!0}),e}();!function(e){e[e.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",e[e.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"}(t||(t={})),function(e){e[e.ALIEN=1]="ALIEN"}(i||(i={}));var f=function(){function e(e){this.game=e}return e.prototype.process=function(e){e.type===i.ALIEN&&this.alien(e)},e.prototype.preview=function(e){if(e.size>128){var t=this.game.animations[this.game.editorManager.currentAnimIndex];this.game.editorManager.isAnimationPreviewPlaying&&(this.game.editorManager.previewAnimationFrame=(this.game.editorManager.previewAnimationFrame+1)%t.frames.length),e.frameIndex=t.frames[this.game.editorManager.previewAnimationFrame]}else this.alien(e)},e.prototype.alien=function(e){e.frameIndex=(e.frameIndex+1)%249},e}(),S=function(){function e(e){this.active=0,this.pool=[],this.lastId=0,this.total=e;for(var t=0;t<e;t++)this.pool.push({id:0,type:0,hitPoints:0,state:0,x:0,y:0,oldX:0,oldY:0,size:0,orderQty:0,orderIndex:0,orderPool:[{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0}],orientation:0,frameIndex:0,active:!1})}return e.prototype.spawn=function(){if(this.active===this.total)throw new Error("Pool Full");var e=this.pool.find((function(e){return!e.active}));if(e)return e.active=!0,e.id=++this.lastId,this.active++,e;throw new Error("Pool Full")},e.prototype.remove=function(e){this.active--,e.active=!1},e}(),v=function(){function e(e){this.scrollX=0,this.scrollY=0,this.zoomFactor=a.CAMERA.ZOOM.FACTOR,this.minZoom=a.CAMERA.ZOOM.MIN,this.maxZoom=a.CAMERA.ZOOM.MAX,this.maxMapX=a.GAME.MAP.WIDTH*a.GAME.TILE.SIZE-1,this.maxMapY=a.GAME.MAP.HEIGHT*a.GAME.TILE.SIZE-1,this.game=e,this.resolution=a.DISPLAY.RESOLUTIONS[a.DISPLAY.DEFAULT_RESOLUTION],this.zoom=1,this.zoomTarget=1,this.aspectRatio=this.resolution.width/this.resolution.height,this.gameScreenWidth=this.resolution.width/this.zoom,this.gameScreenHeight=this.resolution.height/this.zoom,this.initRangeX=this.gameScreenWidth/a.GAME.TILE.SIZE+1,this.initRangeY=this.gameScreenHeight/a.GAME.TILE.SIZE+1,this.scrollEdgeXMax=0,this.scrollEdgeYMax=0,this.scrollEdgeXMin=0,this.scrollEdgeYMin=0,this.gameWidthRatio=0,this.gameHeightRatio=0,this.maxScrollX=0,this.maxScrollY=0}return e.prototype.scroll=function(e){e&&(this.scrollX+=e.dx,this.scrollY+=e.dy);var t=!1;return this.scrollX<0&&(this.scrollX=0,t=!0),this.scrollY<0&&(this.scrollY=0,t=!0),this.scrollX>this.maxScrollX&&(this.scrollX=this.maxScrollX,t=!0),this.scrollY>this.maxScrollY&&(this.scrollY=this.maxScrollY,t=!0),t},e.prototype.setResolution=function(e){this.resolution=e,this.aspectRatio=this.resolution.width/this.resolution.height},e.prototype.updateProperties=function(e){var t=a.CAMERA.SCROLL.BORDER/this.zoom;this.gameScreenWidth=this.resolution.width/this.zoom,this.gameScreenHeight=this.resolution.height/this.zoom,this.scrollEdgeXMax=this.gameScreenWidth-t,this.scrollEdgeYMax=this.gameScreenHeight-t,this.scrollEdgeXMin=t,this.scrollEdgeYMin=t,this.initRangeX=this.gameScreenWidth/a.GAME.TILE.SIZE+1,this.initRangeY=this.gameScreenHeight/a.GAME.TILE.SIZE+1,this.maxScrollX=1+this.maxMapX-this.gameScreenWidth,this.maxScrollY=1+this.maxMapY-this.gameScreenHeight,this.gameWidthRatio=this.gameScreenWidth/e.width,this.gameHeightRatio=this.gameScreenHeight/e.height},e.prototype.animateZoom=function(){if(this.zoom!==this.zoomTarget){var e=this.zoom,t=e;if(t<this.zoomTarget?t=e*this.zoomFactor:t>this.zoomTarget&&(t=e/this.zoomFactor),!(t>this.maxZoom||t<this.minZoom)){var i=this.game.inputManager.mouseX,n=this.game.inputManager.mouseY;this.scrollX=this.scrollX+i/e-i/t,this.scrollY=this.scrollY+n/e-n/t,this.zoom=t,this.updateProperties(this.game.canvasBoundingRect),this.scroll(),this.game.inputManager.setCursorPos(),this.game.rendererManager.setUboWorldTransforms(this.gameScreenWidth,this.gameScreenHeight)}}},e.prototype.resetZoom=function(){this.zoomTarget=1},e.prototype.zoomIn=function(){var e=this.zoom*this.zoomFactor;e>this.maxZoom||(this.zoomTarget=e)},e.prototype.zoomOut=function(){var e=this.zoom/this.zoomFactor;e<this.minZoom||(this.zoomTarget=e)},e}(),M=function(){function e(){this.tickAccumulator=0,this.currentTick=0,this.animAccumulator=0,this.currentAnim=0,this.lastTime=0,this.fps=0,this.fpsLastTime=0,this.timePerTick=a.GAME.TIMING.GAME_SPEEDS[a.GAME.TIMING.DEFAULT_SPEED].value,this.timePerAnim=a.GAME.TIMING.CONSTANT_TIME_PER_ANIM,this.fpsInterval=a.GAME.TIMING.FPS_UPDATE_INTERVAL,this.timerTriggerAccum=3*this.timePerTick}return e.prototype.setGameSpeed=function(e){this.timePerTick=e,this.timerTriggerAccum=3*this.timePerTick},e.prototype.update=function(e){var t=e-this.lastTime;return this.lastTime=e,this.tickAccumulator+=t,this.animAccumulator+=t,t},e.prototype.shouldAnimUpdate=function(){return this.animAccumulator>=this.timePerAnim&&(this.animAccumulator-=this.timePerAnim,this.currentAnim++,!0)},e.prototype.shouldTickUpdate=function(){return this.tickAccumulator>=this.timePerTick&&(this.tickAccumulator-=this.timePerTick,this.currentTick++,!0)},e.prototype.updateFps=function(e,t){this.fps=Math.round(1e3/t),e-this.fpsLastTime>this.fpsInterval&&(this.fpsLastTime=e)},e.prototype.getInterpolation=function(){return this.tickAccumulator/this.timePerTick},e.prototype.needCatchUp=function(e){var t=e-this.lastTime;return!(this.tickAccumulator+t<this.timerTriggerAccum)},e}(),A=function(){function e(e){this.widgetAnim=0,this.widgetAnimTotal=a.UI.WIDGET.TOTAL_FRAMES,this.widgetAnimFrames=a.UI.WIDGET.ANIMATION_FRAMES,this.widgetAnimX=0,this.widgetAnimY=0,this.currentCursorClass="",this.game=e,this.documentElementClassList=document.documentElement.classList}return e.prototype.setCursor=function(e){this.currentCursorClass!==e&&(this.currentCursorClass&&this.documentElementClassList.remove(this.currentCursorClass),this.documentElementClassList.add(e),this.currentCursorClass=e)},e.prototype.animateCursor=function(){this.widgetAnim&&(this.widgetAnim+=1,this.widgetAnim>this.widgetAnimTotal&&(this.widgetAnim=0))},e}(),y=function(){function e(e,t){this.isMapEditorOpen=!1,this.isAnimationPreviewPlaying=!1,this.editorMode="map",this.floatingPaletteElement=null,this.mapEditorContainerElement=null,this.animEditorContainerElement=null,this.tilePreview=null,this.tileInput=null,this.currentTileIndex=0,this.animInput=null,this.animLabelInput=null,this.animListText=null,this.toggleAnimationPlayPauseButton=null,this.totalAnimationsLabel=null,this.currentAnimIndex=0,this.previewAnimationFrame=0,this.previewAnimationOrientation=0,this.game=e,this.fileManager=t}return e.prototype.toggleMapEditor=function(){this.floatingPaletteElement?"none"===this.floatingPaletteElement.style.display||""===this.floatingPaletteElement.style.display?(this.floatingPaletteElement.style.display="block",this.isMapEditorOpen=!0):(this.floatingPaletteElement.style.display="none",this.isMapEditorOpen=!1):this.buildMapEditor()},e.prototype.getSelectedTileIndex=function(){return this.currentTileIndex},e.prototype.setTileSelectIndex=function(e){this.currentTileIndex=e,this.tileInput&&(this.tileInput.value=e.toString()),this.updateTilePreview()},e.prototype.incrementMapTile=function(){this.currentTileIndex=(this.currentTileIndex+1)%a.GAME.TILE.DEPTH,this.tileInput&&(this.tileInput.value=this.currentTileIndex.toString()),this.updateTilePreview()},e.prototype.decrementMapTile=function(){this.currentTileIndex=(this.currentTileIndex-1+a.GAME.TILE.DEPTH)%a.GAME.TILE.DEPTH,this.tileInput&&(this.tileInput.value=this.currentTileIndex.toString()),this.updateTilePreview()},e.prototype.incrementAnimation=function(){this.currentAnimIndex=(this.currentAnimIndex+1)%this.game.animations.length,this.animInput&&(this.animInput.value=this.currentAnimIndex.toString()),this.updateAnimationPreview()},e.prototype.decrementAnimation=function(){this.currentAnimIndex=(this.currentAnimIndex-1+this.game.animations.length)%this.game.animations.length,this.animInput&&(this.animInput.value=this.currentAnimIndex.toString()),this.updateAnimationPreview()},e.prototype.updateTilePreview=function(){this.tilePreview&&(this.tilePreview.style.backgroundPosition="0px -".concat(this.currentTileIndex*a.GAME.TILE.SIZE,"px"),this.tilePreview.style.backgroundSize="".concat(a.GAME.TILE.SIZE,"px ").concat(a.GAME.TILE.SIZE*a.GAME.TILE.DEPTH,"px"))},e.prototype.updateAnimationPreview=function(){null==this.game.animations[this.currentAnimIndex]&&(this.currentAnimIndex=0,null==this.game.animations[this.currentAnimIndex]&&(this.game.animations[this.currentAnimIndex]={label:"default"+this.currentAnimIndex.toString(),frames:[]}),this.animLabelInput&&(this.animLabelInput.value=this.game.animations[this.currentAnimIndex].label),this.animInput&&(this.animInput.value=this.currentAnimIndex.toString())),this.animLabelInput&&(this.animLabelInput.value=this.game.animations[this.currentAnimIndex].label),this.animListText&&(this.animListText.value=JSON.stringify(this.game.animations[this.currentAnimIndex].frames),this.selectFrameInAnimList(this.previewAnimationFrame)),this.previewAnimationFrame=0,this.selectFrameInAnimList(this.previewAnimationFrame),this.totalAnimationsLabel.textContent="Total animations: ".concat(this.game.animations.length)},e.prototype.buildMapEditor=function(){var e=this;this.floatingPaletteElement=document.createElement("div"),this.floatingPaletteElement.style.display="block",this.floatingPaletteElement.id="map-editor";var t=document.createElement("input");t.type="radio",t.name="editor-mode",t.value="map",t.checked=!0,t.addEventListener("change",(function(){e.editorMode="map",e.floatingPaletteElement.classList.remove("anim-mode"),e.floatingPaletteElement.classList.add("map-mode"),e.mapEditorContainerElement&&(e.mapEditorContainerElement.style.display="block"),e.animEditorContainerElement&&(e.animEditorContainerElement.style.display="none"),e.updateTilePreview(),e.updateAnimationPreview()}));var i=document.createElement("label");i.textContent="Map",i.appendChild(t),this.floatingPaletteElement.appendChild(i);var n=document.createElement("input");n.type="radio",n.name="editor-mode",n.value="animation",n.addEventListener("change",(function(){e.editorMode="animation",e.floatingPaletteElement.classList.remove("map-mode"),e.floatingPaletteElement.classList.add("anim-mode"),e.mapEditorContainerElement&&(e.mapEditorContainerElement.style.display="none"),e.animEditorContainerElement&&(e.animEditorContainerElement.style.display="block"),e.updateTilePreview(),e.updateAnimationPreview()}));var r=document.createElement("label");r.textContent="Anim",r.appendChild(n),this.floatingPaletteElement.appendChild(r),this.floatingPaletteElement.classList.add("map-mode"),this.mapEditorContainerElement=document.createElement("div"),this.mapEditorContainerElement.id="map-editor-container",this.floatingPaletteElement.appendChild(this.mapEditorContainerElement),this.mapEditorContainerElement.appendChild(document.createElement("br"));var s=document.createElement("label");s.textContent="Total tiles: ".concat(a.GAME.TILE.DEPTH),this.mapEditorContainerElement.appendChild(s),this.mapEditorContainerElement.appendChild(document.createElement("br"));var o=document.createElement("label");o.textContent="Tile preview:",this.mapEditorContainerElement.appendChild(o),this.mapEditorContainerElement.appendChild(document.createElement("br")),this.tilePreview=document.createElement("div"),this.tilePreview.id="tile-preview",this.updateTilePreview();var l=document.createElement("button");l.textContent="▲",l.title="Next tile (or press '+' key)",l.addEventListener("click",(function(){e.incrementMapTile()}));var h=document.createElement("button");h.textContent="▼",h.title="Previous tile (or press '-' key)",h.addEventListener("click",(function(){e.decrementMapTile()})),this.tileInput=document.createElement("input"),this.tileInput.type="number",this.tileInput.min="0",this.tileInput.max=(a.GAME.TILE.DEPTH-1).toString(),this.tileInput.value=this.currentTileIndex.toString(),this.tileInput.addEventListener("change",(function(){if(e.tileInput){var t=parseInt(e.tileInput.value,10);isNaN(t)&&(t=0);var i=a.GAME.TILE.DEPTH-1;t=Math.max(0,Math.min(t,i)),e.currentTileIndex=t,e.tileInput.value=t.toString(),e.updateTilePreview()}})),this.mapEditorContainerElement.appendChild(this.tilePreview),this.mapEditorContainerElement.appendChild(l),this.mapEditorContainerElement.appendChild(h),this.mapEditorContainerElement.appendChild(this.tileInput);var d=document.createElement("button");d.textContent="Open",d.addEventListener("click",(function(){e.fileManager.openMapFile()}));var m=document.createElement("button");m.textContent="Save",m.addEventListener("click",(function(){e.fileManager.saveMapFile()})),this.mapEditorContainerElement.appendChild(document.createElement("br")),this.mapEditorContainerElement.appendChild(document.createElement("br")),this.mapEditorContainerElement.appendChild(d),this.mapEditorContainerElement.appendChild(m),this.animEditorContainerElement=document.createElement("div"),this.animEditorContainerElement.id="anim-editor-container",this.floatingPaletteElement.appendChild(this.animEditorContainerElement),this.animEditorContainerElement.appendChild(document.createElement("br")),this.totalAnimationsLabel=document.createElement("label"),this.totalAnimationsLabel.textContent="Total animations: ".concat(this.game.animations.length),this.animEditorContainerElement.appendChild(this.totalAnimationsLabel),this.animEditorContainerElement.appendChild(document.createElement("br"));var u=document.createElement("button");u.textContent="▲",u.title="Next animation",u.addEventListener("click",(function(){e.incrementAnimation()}));var c=document.createElement("button");c.textContent="▼",c.title="Previous animation",c.addEventListener("click",(function(){e.decrementAnimation()}));var g=document.createElement("button");g.textContent="+",g.title="Add new animation",g.addEventListener("click",(function(){e.game.animations.splice(e.currentAnimIndex+1,0,{label:"new",frames:[1,2,3,4,5]}),e.currentAnimIndex++,e.animInput&&(e.animInput.value=e.currentAnimIndex.toString()),e.totalAnimationsLabel.textContent="Total animations: ".concat(e.game.animations.length),e.updateAnimationPreview()}));var p=document.createElement("button");p.textContent="-",p.title="Delete current animation",p.addEventListener("click",(function(){e.game.animations.length>1&&(e.game.animations.splice(e.currentAnimIndex,1),e.currentAnimIndex=Math.min(e.currentAnimIndex,e.game.animations.length-1),e.animInput&&(e.animInput.value=e.currentAnimIndex.toString()),e.totalAnimationsLabel.textContent="Total animations: ".concat(e.game.animations.length),e.updateAnimationPreview())})),this.animInput=document.createElement("input"),this.animInput.type="number",this.animInput.min="0",this.animInput.max=(this.game.animations.length-1).toString(),this.animInput.value=this.currentAnimIndex.toString(),this.animInput.addEventListener("change",(function(){if(e.animInput){var t=parseInt(e.animInput.value,10);isNaN(t)&&(t=0);var i=e.game.animations.length-1;t=Math.max(0,Math.min(t,i)),e.currentAnimIndex=t,e.animInput.value=t.toString(),console.log("currentAnimIndex",t),e.updateAnimationPreview()}})),this.animLabelInput=document.createElement("input"),this.animLabelInput.type="text",this.animLabelInput.className="anim-name",this.animLabelInput.value=this.game.animations[this.currentAnimIndex].label,this.animLabelInput.addEventListener("change",(function(){e.animLabelInput&&(console.log("animLabelInput changed to:",e.animLabelInput.value),e.game.animations[e.currentAnimIndex].label=e.animLabelInput.value)})),this.animListText=document.createElement("input"),this.animListText.type="text",this.animListText.value=JSON.stringify(this.game.animations[this.currentAnimIndex].frames),this.animListText.addEventListener("change",(function(){if(e.animListText){console.log("animListText changed to:",e.animListText.value);var t=e.animListText.value;try{var i=JSON.parse(e.animListText.value);if(!Array.isArray(i)||!i.every((function(e){return"number"==typeof e&&e>=0&&e<=255})))throw new Error("Invalid animation list");e.game.animations[e.currentAnimIndex].frames=i}catch(i){console.error("Error parsing animation list:",i),e.animListText.value=t}}}));var E=document.createElement("button");E.textContent="⏮",E.title="Go to first frame",E.addEventListener("click",(function(){e.rewindAnimation()})),this.toggleAnimationPlayPauseButton=document.createElement("button"),this.isAnimationPreviewPlaying?this.toggleAnimationPlayPauseButton.textContent="⏸":this.toggleAnimationPlayPauseButton.textContent="▶",this.toggleAnimationPlayPauseButton.title="Toggle animation play",this.toggleAnimationPlayPauseButton.addEventListener("click",(function(){e.toggleAnimationPlayPause()}));var f=document.createElement("button");f.textContent="⏭",f.title="Go to last frame",f.addEventListener("click",(function(){e.fastForwardAnimation()}));var S=document.createElement("button");S.textContent="Open",S.addEventListener("click",(function(){e.fileManager.openAnimationsFile()}));var v=document.createElement("button");v.textContent="Save",v.addEventListener("click",(function(){e.fileManager.saveAnimationsFile()})),this.animEditorContainerElement.appendChild(u),this.animEditorContainerElement.appendChild(c),this.animEditorContainerElement.appendChild(g),this.animEditorContainerElement.appendChild(p),this.animEditorContainerElement.appendChild(this.animInput),this.animEditorContainerElement.appendChild(this.animLabelInput),this.animEditorContainerElement.appendChild(document.createElement("br")),this.animEditorContainerElement.appendChild(document.createElement("br")),this.animEditorContainerElement.appendChild(this.animListText),this.animEditorContainerElement.appendChild(document.createElement("br")),this.animEditorContainerElement.appendChild(document.createElement("br")),this.animEditorContainerElement.appendChild(E),this.animEditorContainerElement.appendChild(this.toggleAnimationPlayPauseButton),this.animEditorContainerElement.appendChild(f),this.animEditorContainerElement.appendChild(document.createElement("br")),this.animEditorContainerElement.appendChild(document.createElement("br")),this.animEditorContainerElement.appendChild(S),this.animEditorContainerElement.appendChild(v),this.mapEditorContainerElement&&(this.mapEditorContainerElement.style.display="block"),this.animEditorContainerElement&&(this.animEditorContainerElement.style.display="none"),document.body.appendChild(this.floatingPaletteElement),this.addDragElement(this.floatingPaletteElement),this.isMapEditorOpen=!0},e.prototype.addDragElement=function(e){var t=0,i=0,n=0,a=0;function r(r){r.preventDefault(),t=n-r.clientX,i=a-r.clientY,n=r.clientX,a=r.clientY,e.style.top=e.offsetTop-i+"px",e.style.left=e.offsetLeft-t+"px"}function s(){document.removeEventListener("mouseup",s),document.removeEventListener("mousemove",r)}e.addEventListener("mousedown",(function(t){t.target===e&&(t.preventDefault(),n=t.clientX,a=t.clientY,document.addEventListener("mouseup",s),document.addEventListener("mousemove",r))}))},e.prototype.toggleAnimationPlayPause=function(){this.isAnimationPreviewPlaying?this.isAnimationPreviewPlaying=!1:this.isAnimationPreviewPlaying=!0,this.toggleAnimationPlayPauseButton&&(this.isAnimationPreviewPlaying?this.toggleAnimationPlayPauseButton.textContent="⏸":this.toggleAnimationPlayPauseButton.textContent="▶")},e.prototype.rotatePreview=function(e){"animation"===this.editorMode&&(this.previewAnimationOrientation=(this.previewAnimationOrientation+e+16)%16)},e.prototype.changeSelectedFrame=function(e){if(!this.isAnimationPreviewPlaying&&"animation"===this.editorMode){var t=this.game.animations[this.currentAnimIndex];this.previewAnimationFrame=(this.previewAnimationFrame+e+t.frames.length)%t.frames.length,this.selectFrameInAnimList(this.previewAnimationFrame)}},e.prototype.rewindAnimation=function(){this.isAnimationPreviewPlaying||"animation"!==this.editorMode||(this.previewAnimationFrame=0,this.selectFrameInAnimList(this.previewAnimationFrame))},e.prototype.fastForwardAnimation=function(){if(!this.isAnimationPreviewPlaying&&"animation"===this.editorMode){var e=this.game.animations[this.currentAnimIndex];this.previewAnimationFrame=e.frames.length-1,this.selectFrameInAnimList(this.previewAnimationFrame)}},e.prototype.changeSpriteNumber=function(e){if(!this.isAnimationPreviewPlaying&&"animation"===this.editorMode){var t=this.game.animations[this.currentAnimIndex];t.frames[this.previewAnimationFrame]=(t.frames[this.previewAnimationFrame]+e+256)%256}this.animListText&&(this.animListText.value=JSON.stringify(this.game.animations[this.currentAnimIndex].frames))},e.prototype.selectFrameInAnimList=function(e){if(this.animListText){var t=this.animListText.value;try{var i=JSON.parse(t);if(!Array.isArray(i)||e<0||e>=i.length)return;for(var n=t.indexOf("[")+1,a=0;a<e;){if((n=t.indexOf(",",n)+1)<=0)return;a++}for(;n<t.length&&/\s/.test(t[n]);)n++;var r=n,s=t.indexOf(",",r);(-1===s||s>t.indexOf("]",r))&&(s=t.indexOf("]",r));for(var o=s;o>r&&/\s/.test(t[o-1]);)o--;this.animListText.setSelectionRange(r,o),this.animListText.focus()}catch(e){console.error("Error selecting frame in animation list:",e)}}},e}(),I=function(){function e(e){this.fileInput=null,this.fileInputFor="map",this.game=e,this.initFileInput()}return e.prototype.initFileInput=function(){var e=this;this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".json",this.fileInput.style.display="none",this.fileInput.addEventListener("change",(function(t){var i,n=null===(i=t.target.files)||void 0===i?void 0:i[0];if(n){var r=new FileReader;r.onload=function(t){var i;try{var n=JSON.parse(null===(i=t.target)||void 0===i?void 0:i.result);switch(e.fileInputFor){case"map":if(!Array.isArray(n)||n.length!==a.GAME.MAP.WIDTH*a.GAME.MAP.HEIGHT)throw new Error("Invalid map data");e.game.openMap(n);break;case"entity":console.log("Opening entity list file:",n);break;case"animation":if(!Array.isArray(n))throw new Error("Invalid animation data");for(var r=0;r<n.length;r++){var s=n[r];if("string"!=typeof s.label)throw new Error("Invalid animation data");if(!Array.isArray(s.frames)||!s.frames.every((function(e){return"number"==typeof e})))throw new Error("Invalid animation data")}e.game.openAnimations(n);break;default:console.log("unknown file input type")}}catch(e){console.error("Error parsing JSON file:",e)}},r.readAsText(n)}})),document.body.appendChild(this.fileInput)},e.prototype.openMapFile=function(){this.fileInput&&(this.fileInputFor="map",this.fileInput.click())},e.prototype.saveMapFile=function(){this.game.saveMap()},e.prototype.openAnimationsFile=function(){this.fileInput&&(this.fileInputFor="animation",this.fileInput.click())},e.prototype.saveAnimationsFile=function(){this.game.saveAnimations()},e.prototype.openEntityListFile=function(){this.fileInput&&(this.fileInputFor="entity",this.fileInput.click())},e.prototype.saveEntityListFile=function(){this.game.saveEntities()},e}(),T=function(){function e(e){this.game=e,this.startButtonElement=document.createElement("button")}return e.prototype.mainMenu=function(){this.startButtonElement.textContent="Start Game",this.startButtonElement.classList.add("btn-start"),document.body.appendChild(this.startButtonElement)},e.prototype.getStartButtonElement=function(){return this.startButtonElement},e}(),R=function(){function e(e){this.isMenuOpen=!1,this.gameMenuElement=null,this.resolutionSelectElement=null,this.gameSpeedRange=null,this.keyboardScrollSpeedRange=null,this.scrollSpeedRange=null,this.dragSpeedRange=null,this.invertDragCheckbox=null,this.toggleMusicCheckbox=null,this.musicVolumeRange=null,this.toggleSoundCheckbox=null,this.soundVolumeRange=null,this.game=e}return e.prototype.toggleMenu=function(){this.gameMenuElement?"none"===this.gameMenuElement.style.display||""===this.gameMenuElement.style.display?(this.gameMenuElement.style.display="block",this.isMenuOpen=!0):(this.gameMenuElement.style.display="none",this.isMenuOpen=!1):this.buildMenu(),this.gameMenuElement&&(this.setMenuControlValues(),this.oldSettings={resolutionIndex:this.game.resolutionIndex,gameSpeedIndex:this.game.gameSpeedIndex,keyboardSpeedIndex:this.game.keyboardSpeedIndex,scrollSpeedIndex:this.game.scrollSpeedIndex,dragSpeedIndex:this.game.dragSpeedIndex,invertDrag:this.game.invertDrag,musicEnabled:this.game.musicEnabled,musicVolume:this.game.musicVolume,soundEnabled:this.game.soundEnabled,soundVolume:this.game.soundVolume})},e.prototype.cancelMenu=function(){this.game.setResolution(this.oldSettings.resolutionIndex),this.game.setGameSpeed(this.oldSettings.gameSpeedIndex),this.game.setKeyboardSpeed(this.oldSettings.keyboardSpeedIndex),this.game.setScrollSpeed(this.oldSettings.scrollSpeedIndex),this.game.setDragSpeed(this.oldSettings.dragSpeedIndex),this.game.changeInvertDrag(this.oldSettings.invertDrag),this.game.setMusicEnabled(this.oldSettings.musicEnabled),this.game.setMusicVolume(this.oldSettings.musicVolume),this.game.setSoundEnabled(this.oldSettings.soundEnabled),this.game.setSoundVolume(this.oldSettings.soundVolume),this.toggleMenu()},e.prototype.setMenuControlValues=function(){this.resolutionSelectElement&&(this.resolutionSelectElement.selectedIndex=this.game.resolutionIndex),this.gameSpeedRange&&(this.gameSpeedRange.value=this.game.gameSpeedIndex.toString()),this.keyboardScrollSpeedRange&&(this.keyboardScrollSpeedRange.value=this.game.keyboardSpeedIndex.toString()),this.scrollSpeedRange&&(this.scrollSpeedRange.value=this.game.scrollSpeedIndex.toString()),this.dragSpeedRange&&(this.dragSpeedRange.value=this.game.dragSpeedIndex.toString()),this.invertDragCheckbox&&(this.invertDragCheckbox.checked=this.game.invertDrag),this.toggleMusicCheckbox&&(this.toggleMusicCheckbox.checked=this.game.musicEnabled),this.musicVolumeRange&&(this.musicVolumeRange.value=this.game.musicVolume.toString()),this.toggleSoundCheckbox&&(this.toggleSoundCheckbox.checked=this.game.soundEnabled),this.soundVolumeRange&&(this.soundVolumeRange.value=this.game.soundVolume.toString())},e.prototype.getResolutionSelectElement=function(){return this.resolutionSelectElement},e.prototype.buildMenu=function(){var e=this;this.gameMenuElement=document.createElement("div"),this.gameMenuElement.id="game-menu",this.gameMenuElement.style.display="block";var t=document.createElement("h2");t.textContent="Options",this.gameMenuElement.appendChild(t);var i=document.createElement("label");i.htmlFor="resolution-select",i.textContent="Resolution",this.gameMenuElement.appendChild(i),this.resolutionSelectElement=document.createElement("select"),this.resolutionSelectElement.id="resolution-select",this.resolutionSelectElement.classList.add("resolution-select");for(var n=0,r=a.DISPLAY.RESOLUTIONS;n<r.length;n++){var s=r[n],o=s.label,l=s.width,h=s.height,d=document.createElement("option");d.value="".concat(l,"x").concat(h),d.textContent=o,this.resolutionSelectElement.appendChild(d)}this.resolutionSelectElement.selectedIndex=a.DISPLAY.DEFAULT_RESOLUTION,this.resolutionSelectElement.addEventListener("change",(function(){if(e.resolutionSelectElement){var t=e.resolutionSelectElement.selectedIndex;e.game.setResolution(t)}})),this.gameMenuElement.appendChild(this.resolutionSelectElement),this.gameMenuElement.appendChild(document.createElement("br"));var m=document.createElement("label");m.textContent="Game Speed",m.htmlFor="game-speed",this.gameMenuElement.appendChild(m);var u=document.createElement("button");u.textContent="-",u.addEventListener("click",(function(){e.game.decrementGameSpeed(),e.gameSpeedRange&&(e.gameSpeedRange.value=e.game.gameSpeedIndex.toString())})),this.gameMenuElement.appendChild(u),this.gameSpeedRange=document.createElement("input"),this.gameSpeedRange.id="game-speed",this.gameSpeedRange.type="range",this.gameSpeedRange.min="0",this.gameSpeedRange.max="6",this.gameSpeedRange.step="1",this.gameSpeedRange.value="3",this.gameSpeedRange.addEventListener("change",(function(){e.gameSpeedRange&&e.game.setGameSpeed(parseInt(e.gameSpeedRange.value,10))})),this.gameMenuElement.appendChild(this.gameSpeedRange);var c=document.createElement("button");c.classList.add("button-increment"),c.textContent="+",c.addEventListener("click",(function(){e.game.incrementGameSpeed(),e.gameSpeedRange&&(e.gameSpeedRange.value=e.game.gameSpeedIndex.toString())})),this.gameMenuElement.appendChild(c),this.gameMenuElement.appendChild(document.createElement("br"));var g=document.createElement("label");g.textContent="Mouse Scroll Speed",g.htmlFor="scroll-speed",this.gameMenuElement.appendChild(g);var p=document.createElement("button");p.textContent="-",p.addEventListener("click",(function(){e.game.decrementScrollSpeed(),e.scrollSpeedRange&&(e.scrollSpeedRange.value=e.game.scrollSpeedIndex.toString())})),this.gameMenuElement.appendChild(p),this.scrollSpeedRange=document.createElement("input"),this.scrollSpeedRange.id="scroll-speed",this.scrollSpeedRange.type="range",this.scrollSpeedRange.min="0",this.scrollSpeedRange.max="6",this.scrollSpeedRange.step="1",this.scrollSpeedRange.value="3",this.scrollSpeedRange.addEventListener("change",(function(){e.scrollSpeedRange&&e.game.setScrollSpeed(parseInt(e.scrollSpeedRange.value,10))})),this.gameMenuElement.appendChild(this.scrollSpeedRange);var E=document.createElement("button");E.classList.add("button-increment"),E.textContent="+",E.addEventListener("click",(function(){e.game.incrementScrollSpeed(),e.scrollSpeedRange&&(e.scrollSpeedRange.value=e.game.scrollSpeedIndex.toString())})),this.gameMenuElement.appendChild(E),this.gameMenuElement.appendChild(document.createElement("br"));var f=document.createElement("label");f.textContent="Keyboard Scroll Speed",f.htmlFor="keyboard-scroll-speed",this.gameMenuElement.appendChild(f);var S=document.createElement("button");S.textContent="-",S.addEventListener("click",(function(){e.game.decrementKeyboardSpeed(),e.keyboardScrollSpeedRange&&(e.keyboardScrollSpeedRange.value=e.game.keyboardSpeedIndex.toString())})),this.gameMenuElement.appendChild(S),this.keyboardScrollSpeedRange=document.createElement("input"),this.keyboardScrollSpeedRange.id="keyboard-scroll-speed",this.keyboardScrollSpeedRange.type="range",this.keyboardScrollSpeedRange.min="0",this.keyboardScrollSpeedRange.max="6",this.keyboardScrollSpeedRange.step="1",this.keyboardScrollSpeedRange.value="3",this.keyboardScrollSpeedRange.addEventListener("change",(function(){e.keyboardScrollSpeedRange&&(console.log("keyboardScrollSpeedRange changed to:",e.keyboardScrollSpeedRange.value),e.game.setKeyboardSpeed(parseInt(e.keyboardScrollSpeedRange.value,10)))})),this.gameMenuElement.appendChild(this.keyboardScrollSpeedRange);var v=document.createElement("button");v.classList.add("button-increment"),v.textContent="+",v.addEventListener("click",(function(){e.game.incrementKeyboardSpeed(),e.keyboardScrollSpeedRange&&(e.keyboardScrollSpeedRange.value=e.game.keyboardSpeedIndex.toString())})),this.gameMenuElement.appendChild(v),this.gameMenuElement.appendChild(document.createElement("br"));var M=document.createElement("label");M.htmlFor="drag-speed",M.textContent="Drag Scroll Speed",this.gameMenuElement.appendChild(M);var A=document.createElement("button");A.textContent="-",A.addEventListener("click",(function(){e.game.decrementDragSpeed(),e.dragSpeedRange&&(e.dragSpeedRange.value=e.game.dragSpeedIndex.toString())})),this.gameMenuElement.appendChild(A),this.dragSpeedRange=document.createElement("input"),this.dragSpeedRange.id="drag-speed",this.dragSpeedRange.type="range",this.dragSpeedRange.min="0",this.dragSpeedRange.max="6",this.dragSpeedRange.step="1",this.dragSpeedRange.value="3",this.dragSpeedRange.addEventListener("change",(function(){e.dragSpeedRange&&e.game.setDragSpeed(parseInt(e.dragSpeedRange.value,10))})),this.gameMenuElement.appendChild(this.dragSpeedRange);var y=document.createElement("button");y.classList.add("button-increment"),y.textContent="+",y.addEventListener("click",(function(){e.game.incrementDragSpeed(),e.dragSpeedRange&&(e.dragSpeedRange.value=e.game.dragSpeedIndex.toString())})),this.gameMenuElement.appendChild(y),this.gameMenuElement.appendChild(document.createElement("br"));var I=document.createElement("label");I.textContent="Invert Drag Scroll",I.htmlFor="invert-drag",this.gameMenuElement.appendChild(I),this.invertDragCheckbox=document.createElement("input"),this.invertDragCheckbox.id="invert-drag",this.invertDragCheckbox.type="checkbox",this.invertDragCheckbox.checked=!1,this.invertDragCheckbox.addEventListener("change",(function(){var t;e.game.changeInvertDrag(!!(null===(t=e.invertDragCheckbox)||void 0===t?void 0:t.checked))})),this.gameMenuElement.appendChild(this.invertDragCheckbox),this.gameMenuElement.appendChild(document.createElement("br"));var T=document.createElement("label");T.textContent="Toggle Music",T.htmlFor="toggle-music",this.gameMenuElement.appendChild(T),this.toggleMusicCheckbox=document.createElement("input"),this.toggleMusicCheckbox.id="toggle-music",this.toggleMusicCheckbox.type="checkbox",this.toggleMusicCheckbox.checked=!0,this.toggleMusicCheckbox.addEventListener("change",(function(){e.game.toggleMusic()})),this.gameMenuElement.appendChild(this.toggleMusicCheckbox),this.gameMenuElement.appendChild(document.createElement("br"));var R=document.createElement("label");R.htmlFor="music-volume",R.textContent="Music Volume",this.gameMenuElement.appendChild(R);var x=document.createElement("button");x.textContent="-",x.addEventListener("click",(function(){e.game.decrementMusicVolume(),e.musicVolumeRange&&(e.musicVolumeRange.value=e.game.musicVolume.toString())})),this.gameMenuElement.appendChild(x),this.musicVolumeRange=document.createElement("input"),this.musicVolumeRange.id="music-volume",this.musicVolumeRange.type="range",this.musicVolumeRange.min="0",this.musicVolumeRange.max="100",this.musicVolumeRange.step="1",this.musicVolumeRange.value="50",this.musicVolumeRange.addEventListener("change",(function(){e.musicVolumeRange&&e.game.setMusicVolume(parseInt(e.musicVolumeRange.value,10))})),this.gameMenuElement.appendChild(this.musicVolumeRange);var b=document.createElement("button");b.textContent="+",b.classList.add("button-increment"),b.addEventListener("click",(function(){e.game.incrementMusicVolume(),e.musicVolumeRange&&(e.musicVolumeRange.value=e.game.musicVolume.toString())})),this.gameMenuElement.appendChild(b),this.gameMenuElement.appendChild(document.createElement("br"));var C=document.createElement("label");C.textContent="Toggle Sound",C.htmlFor="toggle-sound",this.gameMenuElement.appendChild(C),this.toggleSoundCheckbox=document.createElement("input"),this.toggleSoundCheckbox.id="toggle-sound",this.toggleSoundCheckbox.type="checkbox",this.toggleSoundCheckbox.checked=!0,this.toggleSoundCheckbox.addEventListener("change",(function(){e.game.toggleSound()})),this.gameMenuElement.appendChild(this.toggleSoundCheckbox),this.gameMenuElement.appendChild(document.createElement("br"));var D=document.createElement("label");D.textContent="Sound Volume",D.htmlFor="sound-volume",this.gameMenuElement.appendChild(D);var L=document.createElement("button");L.textContent="-",L.addEventListener("click",(function(){e.game.decrementSoundVolume(),e.soundVolumeRange&&(e.soundVolumeRange.value=e.game.soundVolume.toString())})),this.gameMenuElement.appendChild(L),this.soundVolumeRange=document.createElement("input"),this.soundVolumeRange.id="sound-volume",this.soundVolumeRange.type="range",this.soundVolumeRange.min="0",this.soundVolumeRange.max="100",this.soundVolumeRange.step="1",this.soundVolumeRange.value="50",this.soundVolumeRange.addEventListener("change",(function(){e.soundVolumeRange&&e.game.setSoundVolume(parseInt(e.soundVolumeRange.value,10))})),this.gameMenuElement.appendChild(this.soundVolumeRange);var w=document.createElement("button");w.textContent="+",w.classList.add("button-increment"),w.addEventListener("click",(function(){e.game.incrementSoundVolume(),e.soundVolumeRange&&(e.soundVolumeRange.value=e.game.soundVolume.toString())})),this.gameMenuElement.appendChild(w),this.gameMenuElement.appendChild(document.createElement("br"));var P=document.createElement("button");P.textContent="OK",P.id="ok-button",P.addEventListener("click",(function(){e.game.saveSettingsLocalStorage(),e.toggleMenu()})),this.gameMenuElement.appendChild(P);var _=document.createElement("button");_.textContent="Cancel",_.id="cancel-button",_.addEventListener("click",(function(){e.cancelMenu()})),this.gameMenuElement.appendChild(_),document.body.appendChild(this.gameMenuElement),this.isMenuOpen=!0},e}();function x(e){return new Promise((function(t,i){var n=new Image;n.onload=function(){return t(n)},n.src=e}))}function b(e){var t,i,n,a,r,s,o=window.devicePixelRatio;return e.devicePixelContentBoxSize?(r=(t=[e.devicePixelContentBoxSize[0].inlineSize,e.devicePixelContentBoxSize[0].blockSize])[0],s=t[1],o=1):e.contentBoxSize?e.contentBoxSize[0]?(r=(i=[e.contentBoxSize[0].inlineSize,e.contentBoxSize[0].blockSize])[0],s=i[1]):(r=(n=[e.contentBoxSize.inlineSize,e.contentBoxSize.blockSize])[0],s=n[1]):(r=(a=[e.contentRect.width,e.contentRect.height])[0],s=a[1]),{width:Math.round(r*o),height:Math.round(s*o)}}var C=function(){function e(e){this.soundVolume=1,this.musicVolume=1,this.game=e}return e.prototype.setMusicVolume=function(e){this.musicVolume=e,console.log("setMusicVolume: "+this.musicVolume)},e.prototype.setSoundVolume=function(e){this.soundVolume=e,console.log("setSoundVolume: "+this.soundVolume)},e}(),D=function(){function e(e){this.helpMenuElement=null,this.isHelpMenuOpen=!1,this.game=e}return e.prototype.toggleHelp=function(){this.helpMenuElement?"none"===this.helpMenuElement.style.display||""===this.helpMenuElement.style.display?(this.helpMenuElement.style.display="block",this.isHelpMenuOpen=!0):(this.helpMenuElement.style.display="none",this.isHelpMenuOpen=!1):this.buildHelpMenu()},e.prototype.buildHelpMenu=function(){this.helpMenuElement=document.createElement("div"),this.helpMenuElement.style.display="block",this.helpMenuElement.id="help-menu";var e=document.createElement("h2");e.textContent="Game Shortcuts",this.helpMenuElement.appendChild(e);var t=document.createElement("table");t.id="shortcuts-table",a.SHORTCUT_KEYS.forEach((function(e){var i=document.createElement("tr"),n=document.createElement("td");n.className="shortcut-key",n.textContent=e.key;var a=document.createElement("td");a.className="shortcut-action",a.textContent=e.action,i.appendChild(n),i.appendChild(a),t.appendChild(i)})),this.helpMenuElement.appendChild(t);var i=document.createElement("h2");i.textContent="Editor Shortcuts",this.helpMenuElement.appendChild(i);var n=document.createElement("table");n.id="shortcuts-table",a.EDITOR_KEYS.forEach((function(e){var t=document.createElement("tr"),i=document.createElement("td");i.className="shortcut-key",i.textContent=e.key;var a=document.createElement("td");a.className="shortcut-action",a.textContent=e.action,t.appendChild(i),t.appendChild(a),n.appendChild(t)})),this.helpMenuElement.appendChild(n),document.body.appendChild(this.helpMenuElement),this.isHelpMenuOpen=!0},e}(),L=function(){function e(e,t,i,n){this.lastDisplayWidth=0,this.lastDisplayHeight=0,this.resolutionIndex=a.DISPLAY.DEFAULT_RESOLUTION,this.gameSpeedIndex=a.GAME.TIMING.DEFAULT_SPEED,this.keyboardSpeedIndex=a.CAMERA.SCROLL.DEFAULT_KEYBOARD_SPEED,this.scrollSpeedIndex=a.CAMERA.SCROLL.DEFAULT_SCROLL_SPEED,this.dragSpeedIndex=a.CAMERA.SCROLL.DEFAULT_DRAG_SPEED,this.invertDrag=a.CAMERA.SCROLL.DEFAULT_DRAG_INVERT,this.musicEnabled=!0,this.musicVolume=50,this.soundEnabled=!0,this.soundVolume=50,this.previewEntity=null,this.started=!1,this.isMultiplayer=!1,this.showFPS=!1,this.gamemap=[],this.gameMapChanged=!0,this.minimapRect=[{x:0,y:0,width:0,height:0,r:1,g:1,b:1,a:.15}],this.gameAction=0,this.lastScrollX=-1,this.lastScrollY=-1,this.lastScreenWidth=-1,this.lastScreenHeight=-1,this.animations=[],this.startGameHandler=this.startGame.bind(this),this.handleContextMenu=function(e){return e.preventDefault()},this.canvasElement=document.createElement("canvas"),document.body.appendChild(this.canvasElement),this.canvasBoundingRect=this.canvasElement.getBoundingClientRect();var r=this.canvasElement.getContext("webgl2");if(!r)throw new Error("WebGL2 not supported in this browser");this.gl=r,this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,0),document.addEventListener("contextmenu",this.handleContextMenu);var s,o,l=(s=this.handleCanvasResize.bind(this),function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o&&clearTimeout(o),o=window.setTimeout((function(){return s.apply(void 0,e)}),250)});this.resizeObserver=new ResizeObserver(l),this.resizeObserver.observe(this.canvasElement,{box:"content-box"}),this.timeManager=new M,this.cameraManager=new v(this),this.rendererManager=new p(this.gl,t,e,i,n),this.inputManager=new E(this),this.inputManager.init(),this.resizeCanvasToDisplaySize(this.canvasElement),this.fileManager=new I(this),this.cursorManager=new A(this),this.helpMenuManager=new D(this),this.mainMenuManager=new T(this),this.optionsMenuManager=new R(this),this.editorManager=new y(this,this.fileManager),this.audioManager=new C(this),this.loadSettingsLocalStorage(),this.mainMenuManager.mainMenu(),this.mainMenuManager.getStartButtonElement().addEventListener("click",this.startGameHandler)}return e.prototype.dispose=function(){this.rendererManager.dispose(),document.removeEventListener("contextmenu",this.handleContextMenu),this.mainMenuManager.getStartButtonElement().removeEventListener("click",this.startGameHandler),this.resizeObserver.unobserve(this.canvasElement),this.resizeObserver.disconnect(),this.inputManager.dispose()},e.prototype.handleCanvasResize=function(e){for(var t=0,i=e;t<i.length;t++){var n=b(i[t]),a=n.width,r=n.height;this.lastDisplayWidth=a,this.lastDisplayHeight=r,this.canvasBoundingRect=this.canvasElement.getBoundingClientRect(),this.cameraManager.updateProperties(this.canvasBoundingRect)}},e.prototype.resizeCanvasToDisplaySize=function(e){var t=this.lastDisplayWidth,i=this.lastDisplayHeight,n=e.width!==t||e.height!==i;return n&&(e.width=t,e.height=i,this.gl.viewport(0,0,e.width,e.height),this.rendererManager&&this.rendererManager.worldBuffer&&this.rendererManager.setUboWorldTransforms(this.cameraManager.gameScreenWidth,this.cameraManager.gameScreenHeight)),n},e.prototype.startGame=function(){var e=this;this.cameraManager.setResolution(a.DISPLAY.RESOLUTIONS[this.resolutionIndex]),this.cameraManager.updateProperties(this.canvasBoundingRect),this.rendererManager.setUboWorldTransforms(this.cameraManager.gameScreenWidth,this.cameraManager.gameScreenHeight),this.cursorManager.setCursor("cur-pointer"),this.mainMenuManager.getStartButtonElement().style.display="none",this.initGameStates(),this.started=!0,this.timeManager.lastTime=performance.now(),setInterval((function(){e.checkUpdate()}),a.GAME.TIMING.CHECK_UPDATE_INTERVAL),this.loop(0)},e.prototype.initGameStates=function(){this.entities=new S(a.GAME.ENTITY.INITIAL_POOL_SIZE),this.entityBehaviors=new f(this),this.animations.push({label:"default",frames:[1,2,3,4,5,6,7,8,9,10]});var e=this.entities.spawn();e.type=i.ALIEN,e.hitPoints=100,e.size=128,e.x=1100,e.y=1100,e.frameIndex=33,e.orientation=6,(e=this.entities.spawn()).type=i.ALIEN,e.hitPoints=100,e.size=128,e.x=0,e.y=0,e.frameIndex=212,e.orientation=5,(e=this.entities.spawn()).type=i.ALIEN,e.hitPoints=100,e.size=128,e.x=455,e.y=455,e.frameIndex=122,e.orientation=14,this.gamemap=[];for(var t=0;t<a.GAME.MAP.WIDTH*a.GAME.MAP.HEIGHT;t++)this.gamemap.push(Math.floor(16*Math.random()))},e.prototype.toggleShowFPS=function(){this.showFPS=!this.showFPS},e.prototype.setResolution=function(e){this.resolutionIndex=e,this.cameraManager.setResolution(a.DISPLAY.RESOLUTIONS[this.resolutionIndex]),this.cameraManager.updateProperties(this.canvasBoundingRect),this.cameraManager.scroll({dx:0,dy:0}),this.rendererManager.setUboWorldTransforms(this.cameraManager.gameScreenWidth,this.cameraManager.gameScreenHeight)},e.prototype.setGameSpeed=function(e){this.isMultiplayer||e>=0&&e<a.GAME.TIMING.GAME_SPEEDS.length&&(this.gameSpeedIndex=e,this.timeManager.setGameSpeed(a.GAME.TIMING.GAME_SPEEDS[this.gameSpeedIndex].value))},e.prototype.incrementGameSpeed=function(){this.isMultiplayer||(this.gameSpeedIndex+=1,this.gameSpeedIndex>=a.GAME.TIMING.GAME_SPEEDS.length&&(this.gameSpeedIndex=a.GAME.TIMING.GAME_SPEEDS.length-1),this.timeManager.setGameSpeed(a.GAME.TIMING.GAME_SPEEDS[this.gameSpeedIndex].value))},e.prototype.decrementGameSpeed=function(){this.isMultiplayer||(this.gameSpeedIndex-=1,this.gameSpeedIndex<0&&(this.gameSpeedIndex=0),this.timeManager.setGameSpeed(a.GAME.TIMING.GAME_SPEEDS[this.gameSpeedIndex].value))},e.prototype.setKeyboardSpeed=function(e){e>=0&&e<a.CAMERA.SCROLL.KEYBOARD_SPEEDS.length&&(this.keyboardSpeedIndex=e,this.inputManager.setKeyboardSpeed(a.CAMERA.SCROLL.KEYBOARD_SPEEDS[this.keyboardSpeedIndex].value))},e.prototype.incrementKeyboardSpeed=function(){this.keyboardSpeedIndex+=1,this.keyboardSpeedIndex>=a.CAMERA.SCROLL.KEYBOARD_SPEEDS.length&&(this.keyboardSpeedIndex=a.CAMERA.SCROLL.KEYBOARD_SPEEDS.length-1),this.inputManager.setKeyboardSpeed(a.CAMERA.SCROLL.KEYBOARD_SPEEDS[this.keyboardSpeedIndex].value)},e.prototype.decrementKeyboardSpeed=function(){this.keyboardSpeedIndex-=1,this.keyboardSpeedIndex<0&&(this.keyboardSpeedIndex=0),this.inputManager.setKeyboardSpeed(a.CAMERA.SCROLL.KEYBOARD_SPEEDS[this.keyboardSpeedIndex].value)},e.prototype.setScrollSpeed=function(e){e>=0&&e<a.CAMERA.SCROLL.SCROLL_SPEEDS.length&&(this.scrollSpeedIndex=e,this.inputManager.setScrollSpeed(a.CAMERA.SCROLL.SCROLL_SPEEDS[this.scrollSpeedIndex].value))},e.prototype.incrementScrollSpeed=function(){this.scrollSpeedIndex+=1,this.scrollSpeedIndex>=a.CAMERA.SCROLL.SCROLL_SPEEDS.length&&(this.scrollSpeedIndex=a.CAMERA.SCROLL.SCROLL_SPEEDS.length-1),this.inputManager.setScrollSpeed(a.CAMERA.SCROLL.SCROLL_SPEEDS[this.scrollSpeedIndex].value)},e.prototype.decrementScrollSpeed=function(){this.scrollSpeedIndex-=1,this.scrollSpeedIndex<0&&(this.scrollSpeedIndex=0),this.inputManager.setScrollSpeed(a.CAMERA.SCROLL.SCROLL_SPEEDS[this.scrollSpeedIndex].value)},e.prototype.setDragSpeed=function(e){e>=0&&e<a.CAMERA.SCROLL.DRAG_SPEEDS.length&&(this.dragSpeedIndex=e,this.inputManager.setDragSpeed(a.CAMERA.SCROLL.DRAG_SPEEDS[this.dragSpeedIndex].value,this.invertDrag))},e.prototype.incrementDragSpeed=function(){this.dragSpeedIndex+=1,this.dragSpeedIndex>=a.CAMERA.SCROLL.DRAG_SPEEDS.length&&(this.dragSpeedIndex=a.CAMERA.SCROLL.DRAG_SPEEDS.length-1),this.inputManager.setDragSpeed(a.CAMERA.SCROLL.DRAG_SPEEDS[this.dragSpeedIndex].value,this.invertDrag)},e.prototype.decrementDragSpeed=function(){this.dragSpeedIndex-=1,this.dragSpeedIndex<0&&(this.dragSpeedIndex=0),this.inputManager.setDragSpeed(a.CAMERA.SCROLL.DRAG_SPEEDS[this.dragSpeedIndex].value,this.invertDrag)},e.prototype.changeInvertDrag=function(e){this.invertDrag=e,this.inputManager.setDragSpeed(a.CAMERA.SCROLL.DRAG_SPEEDS[this.dragSpeedIndex].value,this.invertDrag)},e.prototype.procGame=function(){if(this.gameAction)switch(this.gameAction){case a.GAME.ACTIONS.DEFAULT:this.defaultAction();break;case a.GAME.ACTIONS.RELEASESEL:this.selectUnits()}this.gameAction=0,this.inputManager.processInputs()},e.prototype.update=function(e,t){var n=this.cursorManager,r=this.cameraManager,s=this.inputManager,o=this.timeManager,l=o.update(e);for(r.animateZoom(),this.procGame();o.shouldAnimUpdate();)n.animateCursor();for(;o.shouldTickUpdate();)this.tick();if(!t){this.resizeCanvasToDisplaySize(this.canvasElement);var h=[],d=[],m=r.scrollX!==this.lastScrollX||r.scrollY!==this.lastScrollY||r.gameScreenWidth!==this.lastScreenWidth||r.gameScreenHeight!==this.lastScreenHeight;if(this.gameMapChanged||m){this.lastScreenWidth=r.gameScreenWidth,this.lastScreenHeight=r.gameScreenHeight,this.lastScrollX=r.scrollX,this.lastScrollY=r.scrollY;var u=a.GAME.TILE.SIZE,c=Math.floor(this.lastScrollX/u),g=Math.floor(this.lastScrollY/u),p=this.lastScreenWidth/u+1,E=this.lastScreenHeight/u+1;this.lastScrollX%u>u-this.lastScreenWidth%u&&(p+=1),this.lastScrollY%u>u-this.lastScreenHeight%u&&(E+=1);for(var f=0;f<E;f++)for(var S=0;S<p;S++){var v=this.gamemap[c+S+(g+f)*a.GAME.MAP.WIDTH];d.push([S*u-this.lastScrollX%u,f*u-this.lastScrollY%u,v])}}var M=[];if(s.isSelecting){var A=Math.min(s.selX,s.mouseX),y=Math.max(s.selX,s.mouseX),I=Math.min(s.selY,s.mouseY),T=Math.max(s.selY,s.mouseY),R=2/r.zoom;M.push({x:A,y:I,width:y-A,height:R,r:0,g:1,b:0,a:1},{x:A,y:T,width:y-A,height:R,r:0,g:1,b:0,a:1},{x:A,y:I,width:R,height:T-I,r:0,g:1,b:0,a:1},{x:y,y:I,width:R,height:T-I,r:0,g:1,b:0,a:1})}if(m){var x=10/r.zoom,b=Math.min(r.gameScreenWidth,r.gameScreenHeight)/a.UI.MINIMAP_RATIO,C=x,D=r.gameScreenHeight-b-x,L=a.GAME.MAP.WIDTH*a.GAME.TILE.SIZE,w=a.GAME.MAP.HEIGHT*a.GAME.TILE.SIZE,P=b/Math.max(L,w);this.minimapRect[0].x=C+r.scrollX*P,this.minimapRect[0].y=D+r.scrollY*P,this.minimapRect[0].width=r.gameScreenWidth*P,this.minimapRect[0].height=r.gameScreenHeight*P}if(this.editorManager.isMapEditorOpen){if(R=2/r.zoom,u=a.GAME.TILE.SIZE,"map"===this.editorManager.editorMode){for(var _=0;_<=a.GAME.MAP.HEIGHT;_++){var k=_*u-this.lastScrollY%u;M.push({x:0,y:k,width:this.lastScreenWidth,height:R,r:1,g:1,b:1,a:1})}for(var O=0;O<=a.GAME.MAP.WIDTH;O++){var F=O*u-this.lastScrollX%u;M.push({x:F,y:0,width:R,height:this.lastScreenHeight,r:1,g:1,b:1,a:1})}}if(c=Math.floor(r.scrollX/u),g=Math.floor(r.scrollY/u),S=Math.floor((s.mouseX+r.scrollX)/u)-c,f=Math.floor((s.mouseY+r.scrollY)/u)-g,M.push({x:S*u-this.lastScrollX%u,y:f*u-this.lastScrollY%u,width:u,height:u,r:1,g:1,b:1,a:.2}),"animation"===this.editorManager.editorMode){var G=this.editorManager;this.previewEntity||(this.previewEntity=this.entities.spawn(),this.previewEntity.type=i.ALIEN,this.previewEntity.hitPoints=100),this.previewEntity.x=this.lastScreenWidth/2+this.lastScrollX,this.previewEntity.y=this.lastScreenHeight/2+this.lastScrollY,this.previewEntity.orientation=G.previewAnimationOrientation,this.previewEntity.size=512/r.zoom,this.previewEntity.x-=this.previewEntity.size/2,this.previewEntity.y-=this.previewEntity.size/2;var N=G.currentAnimIndex,U=G.previewAnimationFrame,B=this.animations;this.previewEntity.frameIndex=B[N].frames[U];for(var V=B[N].frames[U],Y="Frame: ".concat(U," of 0-").concat(B[N].frames.length-1," (R: ").concat(this.previewEntity.orientation,")"),X="Sprite ".concat(V," "),H=r.gameScreenWidth/2-this.previewEntity.size/2,W=r.gameScreenHeight/2-this.previewEntity.size/2,z=0;z<Y.length;z++){var Z=Y.charCodeAt(z)-32;h.push([H,W,Z,32/r.zoom]),H+=a.FONT_SIZES[Z]/r.zoom}for(H=r.gameScreenWidth/2-this.previewEntity.size/2,W=r.gameScreenHeight/2+128/r.zoom,z=0;z<X.length;z++)Z=X.charCodeAt(z)-32,h.push([H,W,Z,32/r.zoom]),H+=a.FONT_SIZES[Z]/r.zoom}else this.previewEntity&&(this.entities.remove(this.previewEntity),this.previewEntity=null)}else this.previewEntity&&(this.entities.remove(this.previewEntity),this.previewEntity=null);var K=[];if(n.widgetAnim>0&&K.push([n.widgetAnimX-r.scrollX,n.widgetAnimY-r.scrollY,n.widgetAnimFrames[n.widgetAnim],a.GAME.WIDGETS.SIZE/2]),this.showFPS){var j="FPS: "+o.fps.toString();for(S=20/r.zoom,z=0;z<j.length;z++)Z=j.charCodeAt(z)-32,h.push([S,20/r.zoom,Z,32/r.zoom]),S+=a.FONT_SIZES[Z]/r.zoom}this.rendererManager.render(d,this.entities.pool,M,this.minimapRect,K,h,r,o.getInterpolation(),this.gamemap,this.gameMapChanged),this.gameMapChanged=!1}o.updateFps(e,l)},e.prototype.checkUpdate=function(){var e=performance.now();this.timeManager.needCatchUp(e)&&this.update(e,!0)},e.prototype.tick=function(){var e,t=0;if(this.editorManager.isMapEditorOpen&&"animation"===this.editorManager.editorMode)for(var i=0;t<this.entities.active||i<this.entities.total;i++)(e=this.entities.pool[i]).active&&(t+=1,this.entityBehaviors.preview(e));else for(i=0;t<this.entities.active||i<this.entities.total;i++)(e=this.entities.pool[i]).active&&(t+=1,this.entityBehaviors.process(e))},e.prototype.loop=function(e){this.update(e),requestAnimationFrame(this.loop.bind(this))},e.prototype.defaultAction=function(){var e=this.inputManager.gamePosition;this.cursorManager.widgetAnim=1,this.cursorManager.widgetAnimX=e.x-32,this.cursorManager.widgetAnimY=e.y-32},e.prototype.selectUnits=function(){this.inputManager.selectionStart,this.inputManager.selectionEnd},e.prototype.toggleMusic=function(){this.musicEnabled=!this.musicEnabled,this.audioManager.setMusicVolume(this.musicEnabled?this.musicVolume/100:0)},e.prototype.setMusicEnabled=function(e){this.musicEnabled=e,this.audioManager.setMusicVolume(this.musicEnabled?this.musicVolume/100:0)},e.prototype.setMusicVolume=function(e){this.musicVolume=e,this.audioManager.setMusicVolume(this.musicEnabled?this.musicVolume/100:0)},e.prototype.incrementMusicVolume=function(){this.musicVolume+=5,this.musicVolume=5*Math.ceil(this.musicVolume/5),this.musicVolume>100&&(this.musicVolume=100),this.audioManager.setMusicVolume(this.musicEnabled?this.musicVolume/100:0)},e.prototype.decrementMusicVolume=function(){this.musicVolume-=5,this.musicVolume=5*Math.ceil(this.musicVolume/5),this.musicVolume<0&&(this.musicVolume=0),this.audioManager.setMusicVolume(this.musicEnabled?this.musicVolume/100:0)},e.prototype.toggleSound=function(){this.soundEnabled=!this.soundEnabled,this.audioManager.setSoundVolume(this.soundEnabled?this.soundVolume/100:0)},e.prototype.setSoundEnabled=function(e){this.soundEnabled=e,this.audioManager.setSoundVolume(this.soundEnabled?this.soundVolume/100:0)},e.prototype.setSoundVolume=function(e){this.soundVolume=e,this.audioManager.setSoundVolume(this.soundEnabled?this.soundVolume/100:0)},e.prototype.incrementSoundVolume=function(){this.soundVolume+=5,this.soundVolume=5*Math.ceil(this.soundVolume/5),this.soundVolume>100&&(this.soundVolume=100),this.audioManager.setSoundVolume(this.soundEnabled?this.soundVolume/100:0)},e.prototype.decrementSoundVolume=function(){this.soundVolume-=5,this.soundVolume=5*Math.ceil(this.soundVolume/5),this.soundVolume<0&&(this.soundVolume=0),this.audioManager.setSoundVolume(this.soundEnabled?this.soundVolume/100:0)},e.prototype.toggleTerrain=function(){this.rendererManager.toggleTerrain(),this.gameMapChanged=!0},e.prototype.setTileAt=function(e,t,i){var n=a.GAME.TILE.SIZE,r=Math.floor(e/n),s=Math.floor(t/n),o=r+s*a.GAME.MAP.WIDTH;o<0||o>=this.gamemap.length?console.warn("Tile position out of bounds: (".concat(r,", ").concat(s,")")):(this.gamemap[o]=i,this.gameMapChanged=!0)},e.prototype.sampleTileAt=function(e,t){var i=a.GAME.TILE.SIZE,n=Math.floor(e/i),r=Math.floor(t/i),s=n+r*a.GAME.MAP.WIDTH;if(s<0||s>=this.gamemap.length)console.warn("Tile position out of bounds: (".concat(n,", ").concat(r,")"));else{var o=this.gamemap[s];this.editorManager.setTileSelectIndex(o)}},e.prototype.saveMap=function(e,t){e||(e=this.gamemap),t||(t="map_".concat(a.GAME.MAP.WIDTH,"_").concat(a.GAME.MAP.HEIGHT,".json"));var i=JSON.stringify(e,null,2),n=new Blob([i],{type:"application/json"}),r=document.createElement("a");r.href=URL.createObjectURL(n),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)},e.prototype.openMap=function(e){this.gamemap=e,this.gameMapChanged=!0},e.prototype.saveEntities=function(){console.log("Save Entities!")},e.prototype.openEntities=function(){console.log("Open Entities!")},e.prototype.saveAnimations=function(e){e||(e=this.animations);var t=JSON.stringify(e,null,2),i=new Blob([t],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(i),n.download="animations.json",document.body.appendChild(n),n.click(),document.body.removeChild(n)},e.prototype.openAnimations=function(e){this.animations=e,this.editorManager.updateAnimationPreview()},e.prototype.saveSettingsLocalStorage=function(){var e={resolutionIndex:this.resolutionIndex,gameSpeedIndex:this.gameSpeedIndex,keyboardSpeedIndex:this.keyboardSpeedIndex,scrollSpeedIndex:this.scrollSpeedIndex,dragSpeedIndex:this.dragSpeedIndex,invertDrag:this.invertDrag,musicEnabled:this.musicEnabled,musicVolume:this.musicVolume,soundEnabled:this.soundEnabled,soundVolume:this.soundVolume};localStorage.setItem("settings",JSON.stringify(e))},e.prototype.loadSettingsLocalStorage=function(){var e,t,i,n,a,r,s,o,l,h,d=localStorage.getItem("settings");if(d){var m=JSON.parse(d);this.resolutionIndex=null!==(e=m.resolutionIndex)&&void 0!==e?e:this.resolutionIndex,this.gameSpeedIndex=null!==(t=m.gameSpeedIndex)&&void 0!==t?t:this.gameSpeedIndex,this.keyboardSpeedIndex=null!==(i=m.keyboardSpeedIndex)&&void 0!==i?i:this.keyboardSpeedIndex,this.scrollSpeedIndex=null!==(n=m.scrollSpeedIndex)&&void 0!==n?n:this.scrollSpeedIndex,this.dragSpeedIndex=null!==(a=m.dragSpeedIndex)&&void 0!==a?a:this.dragSpeedIndex,this.invertDrag=null!==(r=m.invertDrag)&&void 0!==r?r:this.invertDrag,this.musicEnabled=null!==(s=m.musicEnabled)&&void 0!==s?s:this.musicEnabled,this.musicVolume=null!==(o=m.musicVolume)&&void 0!==o?o:this.musicVolume,this.soundEnabled=null!==(l=m.soundEnabled)&&void 0!==l?l:this.soundEnabled,this.soundVolume=null!==(h=m.soundVolume)&&void 0!==h?h:this.soundVolume,this.setResolution(this.resolutionIndex),this.setGameSpeed(this.gameSpeedIndex),this.setKeyboardSpeed(this.keyboardSpeedIndex),this.setScrollSpeed(this.scrollSpeedIndex),this.setDragSpeed(this.dragSpeedIndex),this.changeInvertDrag(this.invertDrag)}},e}();document.addEventListener("DOMContentLoaded",(function(e){var t=document.createElement("div");t.classList.add("loading-text"),t.textContent="Loading...",document.body.appendChild(t);var i=x("images/alien.png"),n=x("images/map-tiles-vertical.png"),a=x("images/animated-widget-128.png"),r=x("images/font-texture.png");["images/cursor-pointer32.png","images/cursor-target32.png","images/cursor-green1-32.png","images/cursor-green2-32.png","images/cursor-yellow1-32.png","images/cursor-yellow2-32.png","images/cursor-red1-32.png","images/cursor-red2-32.png","images/scroll-bottom32.png","images/scroll-bottom-left32.png","images/scroll-bottom-right32.png","images/scroll-top32.png","images/scroll-top-left32.png","images/scroll-top-right32.png","images/scroll-left32.png","images/scroll-right32.png"].forEach((function(e){(new Image).src=e})),Promise.all([i,n,a,r]).then((function(e){document.body.removeChild(t),window.game?console.error("Game instance already started"):(window.game=new L(e[0],e[1],e[2],e[3]),window.addEventListener("unload",(function(){window.game.dispose()})))}))}))})();