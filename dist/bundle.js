(()=>{"use strict";var t,e,i,r={TEXTURE_MODEL_DATA:new Float32Array([1,0,1,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,0,1,0,1]),RECTANGLE_MODEL_DATA:new Float32Array([1,0,0,1,1,1,1,0,0,0,0,1]),DISPLAY:{RESOLUTIONS:[{label:"16:9 (1920x1080)",width:1920,height:1080},{label:"16:10 (1920x1200)",width:1920,height:1200},{label:"4:3 (1440x1080)",width:1440,height:1080}],SCROLL:{SPEED:50,BORDER:10}},GAME:{ACTIONS:{DEFAULT:1,RELEASESEL:2},TILE:{SIZE:128,DEPTH:64},WIDGETS:{SIZE:64,DEPTH:10,MAX:100},RECTANGLES:{MAX:256},SPRITES:{BITMAP_SIZE:4096,SIZE:64},MAP:{WIDTH:64,HEIGHT:64},TIMING:{TICK_RATE:8,ANIM_RATE:15,FPS_UPDATE_INTERVAL:1e3},ENTITY:{INITIAL_POOL_SIZE:100}}},s="#version 300 es\n\n// The next two are the repeated geometry and UV for each instance of the model\nlayout(location=0) in vec4 aPosition;\nlayout(location=1) in vec2 aTexCoord;\n\n// Those next four use vertexAttribDivisor and are updated every instance\nlayout(location=2) in vec3 aOffset;\nlayout(location=3) in float aScale;\nlayout(location=4) in vec4 aColor;\nlayout(location=5) in float aDepth;\n\nlayout(std140) uniform World {\n    float uWorldX;\n    float uWorldY;\n};\n\nout vec4 vColor;\nout vec2 vTexCoord;\nout float vDepth;\n\nvoid main()\n{\n    vColor = aColor;\n    vTexCoord = aTexCoord;\n    vDepth = aDepth;\n    vec3 pos = aPosition.xyz * aScale + aOffset;\n    \n    // This brings it in the range 0-2. So it also needs a -1 to 1 conversion.\n    gl_Position = vec4((pos.x * uWorldX) - 1.0, (pos.y * uWorldY) + 1.0, pos.z, 1.0);\n\n}",n="#version 300 es\n\nprecision mediump float;\n\nuniform mediump sampler2DArray uSampler;\n\nin vec4 vColor;\nin vec2 vTexCoord;\nin float vDepth;\nout vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vColor * texture(uSampler, vec3(vTexCoord, vDepth));\n}",a=(t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)},function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}),o=function(){function t(t,e,i){this.resources={buffers:[],textures:[],shaders:[]},this.gl=t,this.program=this.createProgram(e,i),this.gl.useProgram(this.program),this.vao=this.gl.createVertexArray(),this.dirtyTransforms=!1}return t.prototype.createProgram=function(t,e){var i=this.gl.createProgram(),r="",s=this.createShader(this.gl.VERTEX_SHADER,t),n=this.createShader(this.gl.FRAGMENT_SHADER,e);s&&n||(r+="\nFailed to create shaders"),this.gl.attachShader(i,s),this.gl.attachShader(i,n),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)||(r+="\nProgram linking failed: ".concat(this.gl.getProgramInfoLog(i))),this.gl.validateProgram(i),this.gl.getProgramParameter(i,this.gl.VALIDATE_STATUS)||(r+="\nProgram validation failed: ".concat(this.gl.getProgramInfoLog(i)));var a=this.gl.getProgramParameter(i,this.gl.ACTIVE_ATTRIBUTES),o=this.gl.getProgramParameter(i,this.gl.ACTIVE_UNIFORMS);if(0===a&&0===o&&(r+="\nWarning: Program has no active attributes or uniforms"),r)throw new Error("WebGL Program creation failed: ".concat(r));return i},t.prototype.createShader=function(t,e){var i=this.gl.createShader(t);if(!i)throw new Error("Failed to create shader");if(this.resources.shaders.push(i),this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw console.error(this.gl.getShaderInfoLog(i)),new Error("Shader compilation failed");return i},t.prototype.setupBufferWithAttributes=function(t,e,i,r){var s=this;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,i),r.forEach((function(t){var e=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=void 0===a?0:a;s.setupAttribute(e,i,r,n,o)}))},t.prototype.createBuffer=function(){var t=this.gl.createBuffer();return this.resources.buffers.push(t),t},t.prototype.createTexture=function(){var t=this.gl.createTexture();return this.resources.textures.push(t),t},t.prototype.setupAttribute=function(t,e,i,r,s){void 0===s&&(s=0),this.gl.vertexAttribPointer(t,e,this.gl.FLOAT,!1,i,r),this.gl.enableVertexAttribArray(t),this.gl.vertexAttribDivisor(t,s)},t.prototype.dispose=function(){var t=this;this.resources.textures.forEach((function(e){return t.gl.deleteTexture(e)})),this.resources.buffers.forEach((function(e){return t.gl.deleteBuffer(e)})),this.resources.shaders.forEach((function(e){return t.gl.deleteShader(e)})),this.gl.deleteProgram(this.program),this.gl.deleteVertexArray(this.vao),this.resources.textures=[],this.resources.buffers=[],this.resources.shaders=[]},t}(),h=function(t){function e(e,i,r){var a=t.call(this,e,s,n)||this;return a.renderMax=0,a.image=i,a.texture=a.createTexture(),a.modelBuffer=a.createBuffer(),a.transformBuffer=a.createBuffer(),a.transformData=new Float32Array(7*r),a.setupVAO(),a}return a(e,t),e.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.texImage3D(this.gl.TEXTURE_2D_ARRAY,0,this.gl.RGBA,r.GAME.TILE.SIZE,r.GAME.TILE.SIZE,r.GAME.TILE.DEPTH,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.image),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.generateMipmap(this.gl.TEXTURE_2D_ARRAY),this.setupBufferWithAttributes(this.modelBuffer,r.TEXTURE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,16,0],[1,2,16,8]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[2,2,28,0,1],[3,1,28,8,1],[4,3,28,12,1],[5,1,28,24,1]]),this.gl.bindVertexArray(null)},e.prototype.updateTransformData=function(t){void 0===t&&(t=[]);for(var e=0;e<t.length;e++){var i=7*e;this.transformData[i]=t[e][0],this.transformData[i+1]=t[e][1],this.transformData[i+2]=r.GAME.TILE.SIZE,this.transformData[i+3]=1,this.transformData[i+4]=1,this.transformData[i+5]=1,this.transformData[i+6]=t[e][2]}this.renderMax=t.length,this.dirtyTransforms=!0},e.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,7*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},e}(o),l=function(t){function e(e,i,r){var a=t.call(this,e,s,n)||this;return a.renderMax=0,a.image=i,a.texture=a.createTexture(),a.modelBuffer=a.createBuffer(),a.transformBuffer=a.createBuffer(),a.transformData=new Float32Array(7*r),a.setupVAO(),a}return a(e,t),e.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.texImage3D(this.gl.TEXTURE_2D_ARRAY,0,this.gl.RGBA,r.GAME.WIDGETS.SIZE,r.GAME.WIDGETS.SIZE,r.GAME.WIDGETS.DEPTH,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.image),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.generateMipmap(this.gl.TEXTURE_2D_ARRAY),this.setupBufferWithAttributes(this.modelBuffer,r.TEXTURE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,16,0],[1,2,16,8]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[2,2,28,0,1],[3,1,28,8,1],[4,3,28,12,1],[5,1,28,24,1]]),this.gl.bindVertexArray(null)},e.prototype.updateTransformData=function(t){void 0===t&&(t=[]);for(var e=0;e<t.length;e++){var i=7*e;this.transformData[i]=t[e][0],this.transformData[i+1]=t[e][1],this.transformData[i+2]=t[e][3],this.transformData[i+3]=1,this.transformData[i+4]=1,this.transformData[i+5]=1,this.transformData[i+6]=t[e][2]}this.renderMax=t.length,this.dirtyTransforms=!0},e.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texture),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,7*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},e}(o),u=function(t){function e(e,i,r){var s=t.call(this,e,"#version 300 es\n\n// The next two are the repeated geometry and UV for each instance of the model\nlayout(location=0) in vec4 aPosition;\nlayout(location=1) in vec2 aTexCoord;\n\n// Those next four use vertexAttribDivisor and are updated every instance\nlayout(location=2) in vec3 aOffset;\nlayout(location=3) in float aScale;\nlayout(location=4) in vec4 aColor;\nlayout(location=5) in vec2 aUV;\n\nlayout(std140) uniform World {\n    float uWorldX;\n    float uWorldY;\n};\n\nout vec4 vColor;\nout vec2 vTexCoord;\n\nvoid main()\n{\n    vColor = aColor;\n    vTexCoord = vec2(aTexCoord * 0.015625) + aUV;\n\n    vec3 pos = aPosition.xyz * aScale + aOffset;\n\n    // This brings it in the range 0-2. So it also needs a -1 to 1 conversion.\n    gl_Position = vec4((pos.x * uWorldX) - 1.0, (pos.y * uWorldY) + 1.0, pos.z, 1.0);\n\n}","#version 300 es\n\nprecision mediump float;\n\nuniform mediump sampler2D uSampler;\n\nin vec4 vColor;\nin vec2 vTexCoord;\nout vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vColor * texture(uSampler, vTexCoord);\n}")||this;return s.renderMax=0,s.image=i,s.texture=s.createTexture(),s.modelBuffer=s.createBuffer(),s.transformBuffer=s.createBuffer(),s.transformData=new Float32Array(8*r),s.setupVAO(),s}return a(e,t),e.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,r.GAME.SPRITES.BITMAP_SIZE,r.GAME.SPRITES.BITMAP_SIZE,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.image),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.setupBufferWithAttributes(this.modelBuffer,r.TEXTURE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,16,0],[1,2,16,8]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[2,2,32,0,1],[3,1,32,8,1],[4,3,32,12,1],[5,2,32,24,1]]),this.gl.bindVertexArray(null)},e.prototype.updateTransformData=function(t,e){for(var i=e.scrollX,r=e.scrollY,s=e.gameScreenWidth,n=e.gameScreenHeight,a=0,o=0,h=t.length;o<h;o++){var l=t[o];if(l.active){var u=l.x,c=l.y;if(!(u+128<i||u>i+s||c+128<r||c>r+n)){var d=8*a,m=l.frameIndex,g=l.orientation,p=m%16*.015625+g%4*.25,f=.015625*Math.floor(m/16)+.25*Math.floor(g/4);this.transformData[d]=u-i,this.transformData[d+1]=c-r,this.transformData[d+2]=128,this.transformData[d+3]=1,this.transformData[d+4]=1,this.transformData[d+5]=1,this.transformData[d+6]=p,this.transformData[d+7]=f,a++}}}this.renderMax=a,this.dirtyTransforms=!0},e.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,8*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},e}(o),c=function(t){function e(e,i){var r=t.call(this,e,"#version 300 es\n\n// The next two are the repeated geometry and UV for each instance of the model\nlayout(location=0) in vec4 aPosition;\n\n// Those next four use vertexAttribDivisor and are updated every instance\nlayout(location=1) in vec3 aOffset;\nlayout(location=2) in float aScaleX;\nlayout(location=3) in float aScaleY;\nlayout(location=4) in vec4 aColor;\n\nlayout(std140) uniform World {\n    float uWorldX;\n    float uWorldY;\n};\n\nout vec4 vColor;\n\nvoid main()\n{\n    vColor = aColor;\n    vec3 pos = aPosition.xyz * vec3(aScaleX, aScaleY, 1.0) + aOffset;\n    \n    // This brings it in the range 0-2. So it also needs a -1 to 1 conversion.\n    gl_Position = vec4((pos.x * uWorldX) - 1.0, (pos.y * uWorldY) + 1.0, pos.z, 1.0);\n\n}","#version 300 es\n\nprecision mediump float;\n\nin vec4 vColor;\nout vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vColor;\n}")||this;return r.renderMax=0,r.modelBuffer=r.createBuffer(),r.transformBuffer=r.createBuffer(),r.transformData=new Float32Array(8*i),r.setupVAO(),r}return a(e,t),e.prototype.updateTransformData=function(t){for(var e=0;e<t.length;e++){var i=8*e;this.transformData[i]=t[e].x,this.transformData[i+1]=t[e].y,this.transformData[i+2]=t[e].width,this.transformData[i+3]=t[e].height,this.transformData[i+4]=t[e].r,this.transformData[i+5]=t[e].g,this.transformData[i+6]=t[e].b,this.transformData[i+7]=t[e].a}this.renderMax=t.length,this.dirtyTransforms=!0},e.prototype.setupVAO=function(){this.gl.bindVertexArray(this.vao),this.setupBufferWithAttributes(this.modelBuffer,r.RECTANGLE_MODEL_DATA,this.gl.STATIC_DRAW,[[0,2,8,0]]),this.setupBufferWithAttributes(this.transformBuffer,this.transformData,this.gl.DYNAMIC_DRAW,[[1,2,32,0,1],[2,1,32,8,1],[3,1,32,12,1],[4,4,32,16,1]]),this.gl.bindVertexArray(null)},e.prototype.render=function(){this.gl.useProgram(this.program),this.gl.bindVertexArray(this.vao),this.dirtyTransforms&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.transformBuffer),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.transformData,0,8*this.renderMax),this.dirtyTransforms=!1),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,this.renderMax)},e}(o),d=function(){function t(t,e,i,s){this.gl=t,this.tileRenderer=new h(this.gl,e,r.GAME.MAP.WIDTH*r.GAME.MAP.HEIGHT),this.widgetRenderer=new l(this.gl,s,r.GAME.WIDGETS.MAX),this.spriteRenderer=new u(this.gl,i,r.GAME.ENTITY.INITIAL_POOL_SIZE),this.rectangleRenderer=new c(this.gl,r.GAME.RECTANGLES.MAX),this.worldBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.UNIFORM_BUFFER,this.worldBuffer),this.gl.bufferData(this.gl.UNIFORM_BUFFER,2*Float32Array.BYTES_PER_ELEMENT,this.gl.DYNAMIC_DRAW),this.initUboBindings()}return t.prototype.initUboBindings=function(){for(var e=0,i=[this.tileRenderer.program,this.widgetRenderer.program,this.spriteRenderer.program,this.rectangleRenderer.program].filter((function(t){return null!=t}));e<i.length;e++){var r=i[e],s=this.gl.getUniformBlockIndex(r,"World");this.gl.uniformBlockBinding(r,s,t.WORLD_BINDING_POINT)}this.gl.bindBufferBase(this.gl.UNIFORM_BUFFER,t.WORLD_BINDING_POINT,this.worldBuffer)},t.prototype.setUboWorldTransforms=function(t,e){var i=new Float32Array([2/t,2/-e]);this.gl.bindBuffer(this.gl.UNIFORM_BUFFER,this.worldBuffer),this.gl.bufferSubData(this.gl.UNIFORM_BUFFER,0,i)},t.prototype.render=function(t,e,i,r,s,n){this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),t.length&&this.tileRenderer.updateTransformData(t),this.tileRenderer.render(),this.spriteRenderer.updateTransformData(e,s),this.spriteRenderer.render(),i.length&&(this.rectangleRenderer.updateTransformData(i),this.rectangleRenderer.render()),r.length&&(this.widgetRenderer.updateTransformData(r),this.widgetRenderer.render()),this.gl.flush()},t.prototype.dispose=function(){this.tileRenderer.dispose(),this.spriteRenderer.dispose(),this.rectangleRenderer.dispose(),this.widgetRenderer.dispose()},t.WORLD_BINDING_POINT=0,t}(),m=function(){function t(t){this.widgetAnim=0,this.widgetAnimTotal=6,this.widgetAnimX=0,this.widgetAnimY=0,this.currentCursorClass="",this.mapEditorElement=null,this.tilePreview=null,this.tileInput=null,this.fileInput=null,this.fileInputFor="map",this.currentTileIndex=0,this.game=t,this.documentElementClassList=document.documentElement.classList,this.startButtonElement=document.createElement("button"),this.resolutionSelectElement=document.createElement("select")}return t.prototype.mainMenu=function(){this.startButtonElement.textContent="Start Game",this.startButtonElement.classList.add("btn-start"),document.body.appendChild(this.startButtonElement),this.resolutionSelectElement.classList.add("resolution-select");for(var t=0,e=r.DISPLAY.RESOLUTIONS;t<e.length;t++){var i=e[t],s=i.label,n=i.width,a=i.height,o=document.createElement("option");o.value="".concat(n,"x").concat(a),o.textContent=s,this.resolutionSelectElement.appendChild(o)}document.body.appendChild(this.resolutionSelectElement)},t.prototype.setCursor=function(t){this.currentCursorClass!==t&&(this.currentCursorClass&&this.documentElementClassList.remove(this.currentCursorClass),this.documentElementClassList.add(t),this.currentCursorClass=t)},t.prototype.toggleGameMenu=function(){console.log("Toggle Options Menu")},t.prototype.animateCursor=function(){this.widgetAnim&&(this.widgetAnim+=1,this.widgetAnim>this.widgetAnimTotal&&(this.widgetAnim=0))},t.prototype.getStartButtonElement=function(){return this.startButtonElement},t.prototype.getResolutionSelectElement=function(){return this.resolutionSelectElement},t.prototype.toggleMapEditor=function(){this.mapEditorElement?"none"===this.mapEditorElement.style.display||""===this.mapEditorElement.style.display?this.mapEditorElement.style.display="block":this.mapEditorElement.style.display="none":this.buildMapEditor()},t.prototype.isMapEditorVisible=function(){return null!==this.mapEditorElement&&"block"===this.mapEditorElement.style.display},t.prototype.getSelectedTileIndex=function(){return this.currentTileIndex},t.prototype.buildMapEditor=function(){var t=this;this.mapEditorElement=document.createElement("div"),this.mapEditorElement.id="map-editor",Object.assign(this.mapEditorElement.style,{position:"absolute",top:"10px",right:"10px",width:"130px",height:"180px",textAlign:"center",backgroundColor:"#ccc",border:"1px solid #333",padding:"10px",zIndex:"10",cursor:"move",display:"block"}),this.tilePreview=document.createElement("div"),Object.assign(this.tilePreview.style,{width:"128px",height:"128px",backgroundImage:"url('images/map-tiles-vertical.png')",backgroundRepeat:"no-repeat",cursor:"default",marginBottom:"10px",border:"1px solid #333"}),this.updateTilePreview();var e=document.createElement("button");e.textContent="▲",e.title="Next tile (or press '+' key)",e.addEventListener("click",(function(){t.incrementMapTile()}));var i=document.createElement("button");i.textContent="▼",i.title="Previous tile (or press '-' key)",i.addEventListener("click",(function(){t.decrementMapTile()})),this.tileInput=document.createElement("input"),this.tileInput.type="number",this.tileInput.min="0",this.tileInput.max="63",this.tileInput.value=this.currentTileIndex.toString(),this.tileInput.addEventListener("change",(function(){if(t.tileInput){var e=parseInt(t.tileInput.value,10);!isNaN(e)&&e>=0&&e<64&&(t.currentTileIndex=e,t.updateTilePreview())}})),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".json",this.fileInput.style.display="none",this.fileInput.addEventListener("change",(function(e){var i,s=null===(i=e.target.files)||void 0===i?void 0:i[0];if(s){var n=new FileReader;n.onload=function(e){var i;try{var s=JSON.parse(null===(i=e.target)||void 0===i?void 0:i.result);if(!Array.isArray(s)||s.length!==r.GAME.MAP.WIDTH*r.GAME.MAP.HEIGHT)throw new Error("Invalid map data");t.game.openMap(s)}catch(t){console.error("Error parsing JSON file:",t)}},n.readAsText(s)}}));var s=document.createElement("button");s.textContent="Open",s.addEventListener("click",(function(){t.openMapFile()}));var n=document.createElement("button");n.textContent="Save",n.addEventListener("click",(function(){t.saveMapFile()})),this.mapEditorElement.appendChild(this.tilePreview),this.mapEditorElement.appendChild(e),this.mapEditorElement.appendChild(i),this.mapEditorElement.appendChild(this.tileInput),this.mapEditorElement.appendChild(this.fileInput),this.mapEditorElement.appendChild(document.createElement("br")),this.mapEditorElement.appendChild(s),this.mapEditorElement.appendChild(n),document.body.appendChild(this.mapEditorElement),this.addDragElement(this.mapEditorElement)},t.prototype.addDragElement=function(t){var e=0,i=0,r=0,s=0;function n(n){n.preventDefault(),e=r-n.clientX,i=s-n.clientY,r=n.clientX,s=n.clientY,t.style.top=t.offsetTop-i+"px",t.style.left=t.offsetLeft-e+"px"}function a(){document.removeEventListener("mouseup",a),document.removeEventListener("mousemove",n)}t.addEventListener("mousedown",(function(e){e.target===t&&(e.preventDefault(),r=e.clientX,s=e.clientY,document.addEventListener("mouseup",a),document.addEventListener("mousemove",n))}))},t.prototype.incrementMapTile=function(){this.currentTileIndex=(this.currentTileIndex+1)%64,this.updateTilePreview(),this.tileInput&&(this.tileInput.value=this.currentTileIndex.toString())},t.prototype.decrementMapTile=function(){this.currentTileIndex=(this.currentTileIndex-1+64)%64,this.updateTilePreview(),this.tileInput&&(this.tileInput.value=this.currentTileIndex.toString())},t.prototype.updateTilePreview=function(){this.tilePreview&&(this.tilePreview.style.backgroundPosition="0px -".concat(128*this.currentTileIndex,"px"),this.tilePreview.style.backgroundSize="128px 8192px")},t.prototype.setTileSelectIndex=function(t){this.currentTileIndex=t,this.tileInput&&(this.tileInput.value=t.toString()),this.updateTilePreview()},t.prototype.openMapFile=function(){this.fileInput&&(this.fileInputFor="map",this.fileInput.click())},t.prototype.saveMapFile=function(){this.game.saveMap()},t.prototype.openEntityListFile=function(){this.fileInput&&(this.fileInputFor="entity",this.fileInput.click())},t.prototype.saveEntityListFile=function(){this.game.saveEntities()},t.prototype.openAnimationListFile=function(){this.fileInput&&(this.fileInputFor="animation",this.fileInput.click())},t.prototype.saveAnimationListFile=function(){this.game.saveAnimationList()},t}(),g=function(){function t(t){this.keysPressed={},this.selecting=!1,this.mouseX=0,this.mouseY=0,this.gameMouseX=0,this.gameMouseY=0,this.selX=0,this.selY=0,this.gameSelStartX=0,this.gameSelStartY=0,this.gameSelEndX=0,this.gameSelEndY=0,this.scrollNowX=0,this.scrollNowY=0,this.keyboardUp=!1,this.keyboardDown=!1,this.keyboardLeft=!1,this.keyboardRight=!1,this.keyDownHandler=this.handleKeyDown.bind(this),this.keyUpHandler=this.handleKeyUp.bind(this),this.mouseMoveHandler=this.handleMouseMove.bind(this),this.mouseDownHandler=this.handleMouseDown.bind(this),this.mouseUpHandler=this.handleMouseUp.bind(this),this.mouseWheelHandler=this.handleMouseWheel.bind(this),this.game=t}return Object.defineProperty(t.prototype,"gamePosition",{get:function(){return{x:this.gameMouseX,y:this.gameMouseY}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectionStart",{get:function(){return{x:this.gameSelStartX,y:this.gameSelStartY}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectionEnd",{get:function(){return{x:this.gameSelEndX,y:this.gameSelEndY}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scrollVelocity",{get:function(){return{dx:this.scrollNowX,dy:this.scrollNowY}},enumerable:!1,configurable:!0}),t.prototype.init=function(){window.addEventListener("keydown",this.keyDownHandler),window.addEventListener("keyup",this.keyUpHandler),window.addEventListener("mousemove",this.mouseMoveHandler),window.addEventListener("mousedown",this.mouseDownHandler),window.addEventListener("mouseup",this.mouseUpHandler),window.addEventListener("wheel",this.mouseWheelHandler,{passive:!1})},t.prototype.dispose=function(){window.removeEventListener("keydown",this.keyDownHandler),window.removeEventListener("keyup",this.keyUpHandler),window.removeEventListener("mousemove",this.mouseMoveHandler),window.removeEventListener("mousedown",this.mouseDownHandler),window.removeEventListener("mouseup",this.mouseUpHandler),window.removeEventListener("wheel",this.mouseWheelHandler)},t.prototype.handleKeyDown=function(t){if(this.game.uiManager.isMapEditorVisible()){if("NumPad+"===t.key||"+"===t.key||!t.shiftKey&&"="===t.key)return t.preventDefault(),void this.game.uiManager.incrementMapTile();if("NumPad-"===t.key||"-"===t.key||"_"===t.key)return t.preventDefault(),void this.game.uiManager.decrementMapTile();t.ctrlKey&&"s"===t.key&&(t.preventDefault(),this.game.uiManager.saveMapFile()),t.ctrlKey&&"o"===t.key&&(t.preventDefault(),this.game.uiManager.openMapFile())}if("F10"===t.key)return t.preventDefault(),void this.game.uiManager.toggleMapEditor();this.keysPressed[t.key]=!0,!t.ctrlKey||"+"!==t.key&&"-"!==t.key&&"="!==t.key&&"_"!==t.key||t.preventDefault()},t.prototype.handleKeyUp=function(t){this.keysPressed[t.key]=!1},t.prototype.handleMouseMove=function(t){if(t&&this.setCursorPos(t),this.scrollNowX=0,this.scrollNowY=0,this.game.uiManager.isMapEditorVisible()){if(t&&t.target!==this.game.canvasElement)return;if(t&&1===t.buttons){var e=this.game.uiManager.getSelectedTileIndex();this.game.setTileAt(this.gameMouseX,this.gameMouseY,e)}t&&2===t.buttons&&this.game.sampleTileAt(this.gameMouseX,this.gameMouseY)}else this.mouseX>this.game.cameraManager.scrollEdgeX&&(this.scrollNowX=r.DISPLAY.SCROLL.SPEED),this.mouseY>this.game.cameraManager.scrollEdgeY&&(this.scrollNowY=r.DISPLAY.SCROLL.SPEED),this.mouseX<r.DISPLAY.SCROLL.BORDER&&(this.scrollNowX=-r.DISPLAY.SCROLL.SPEED),this.mouseY<r.DISPLAY.SCROLL.BORDER&&(this.scrollNowY=-r.DISPLAY.SCROLL.SPEED)},t.prototype.handleMouseDown=function(t){if(this.setCursorPos(t),this.game.uiManager.isMapEditorVisible()){if(t.target!==this.game.canvasElement)return;if(0===t.button){var e=this.game.uiManager.getSelectedTileIndex();this.game.setTileAt(this.gameMouseX,this.gameMouseY,e)}2===t.button&&this.game.sampleTileAt(this.gameMouseX,this.gameMouseY)}else this.selecting||(0===t.button&&(this.selecting=!0,this.selX=this.mouseX,this.selY=this.mouseY,this.gameSelStartX=this.selX+this.game.cameraManager.scrollX,this.gameSelStartY=this.selY+this.game.cameraManager.scrollY,this.game.uiManager.setCursor("cur-target")),2===t.button&&(this.game.gameAction=r.GAME.ACTIONS.DEFAULT))},t.prototype.handleMouseUp=function(t){this.setCursorPos(t),this.game.uiManager.isMapEditorVisible()||0===t.button&&(this.gameSelEndX=this.mouseX+this.game.cameraManager.scrollX,this.gameSelEndY=this.mouseY+this.game.cameraManager.scrollY,this.selecting=!1,this.game.gameAction=r.GAME.ACTIONS.RELEASESEL,this.game.uiManager.setCursor("cur-pointer"))},t.prototype.handleMouseWheel=function(t){t.ctrlKey&&(t.preventDefault(),t.stopImmediatePropagation()),this.selecting||(t.deltaY<0?this.game.cameraManager.zoomIn(this.mouseX,this.mouseY):t.deltaY>0&&this.game.cameraManager.zoomOut(this.mouseX,this.mouseY))},t.prototype.setCursorPos=function(t){this.mouseX=t.clientX*(this.game.cameraManager.gameScreenWidth/this.game.canvasBoundingRect.width),this.mouseY=t.clientY*(this.game.cameraManager.gameScreenHeight/this.game.canvasBoundingRect.height),this.gameMouseX=this.mouseX+this.game.cameraManager.scrollX,this.gameMouseY=this.mouseY+this.game.cameraManager.scrollY},t.prototype.processInputs=function(){this.keysPressed.ArrowUp||this.keysPressed.w?(this.scrollNowY=-r.DISPLAY.SCROLL.SPEED,this.keyboardUp=!0):this.keyboardUp&&(this.keyboardUp=!1,this.scrollNowY=0,this.handleMouseMove()),this.keysPressed.ArrowDown||this.keysPressed.s?(this.scrollNowY=r.DISPLAY.SCROLL.SPEED,this.keyboardDown=!0):this.keyboardDown&&(this.keyboardDown=!1,this.scrollNowY=0,this.handleMouseMove()),this.keysPressed.ArrowLeft||this.keysPressed.a?(this.scrollNowX=-r.DISPLAY.SCROLL.SPEED,this.keyboardLeft=!0):this.keyboardLeft&&(this.keyboardLeft=!1,this.scrollNowX=0,this.handleMouseMove()),this.keysPressed.ArrowRight||this.keysPressed.d?(this.scrollNowX=r.DISPLAY.SCROLL.SPEED,this.keyboardRight=!0):this.keyboardRight&&(this.keyboardRight=!1,this.scrollNowX=0,this.handleMouseMove()),this.selecting||this.game.cameraManager.scroll(this.scrollVelocity)},Object.defineProperty(t.prototype,"isSelecting",{get:function(){return this.selecting},enumerable:!1,configurable:!0}),t}();!function(t){t[t.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",t[t.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"}(e||(e={})),function(t){t[t.ALIEN=1]="ALIEN"}(i||(i={}));var p=function(){function t(t){this.game=t}return t.prototype.process=function(t){t.type===i.ALIEN&&this.alien(t)},t.prototype.alien=function(t){t.frameIndex=(t.frameIndex+1)%249},t}(),f=function(){function t(t){this.active=0,this.pool=[],this.lastId=0,this.total=t;for(var e=0;e<t;e++)this.pool.push({id:0,type:0,hitPoints:0,state:0,x:0,y:0,oldX:0,oldY:0,orderQty:0,orderIndex:0,orderPool:[{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0},{order:0,x:0,y:0,entityId:0}],orientation:0,frameIndex:0,active:!1})}return t.prototype.spawn=function(){if(this.active===this.total)throw new Error("Pool Full");var t=this.pool.find((function(t){return!t.active}));if(t)return t.active=!0,t.id=++this.lastId,this.active++,t;throw new Error("Pool Full")},t.prototype.remove=function(t){this.active--,t.active=!1},t}(),E=function(){function t(t){this.scrollX=0,this.scrollY=0,this.minZoom=.5,this.maxZoom=2,this.maxMapX=r.GAME.MAP.WIDTH*r.GAME.TILE.SIZE-1,this.maxMapY=r.GAME.MAP.HEIGHT*r.GAME.TILE.SIZE-1,this.game=t,this.resolution=r.DISPLAY.RESOLUTIONS[0],this.zoom=1,this.aspectRatio=this.resolution.width/this.resolution.height,this.gameScreenWidth=this.resolution.width/this.zoom,this.gameScreenHeight=this.resolution.height/this.zoom,this.initRangeX=this.gameScreenWidth/r.GAME.TILE.SIZE+1,this.initRangeY=this.gameScreenHeight/r.GAME.TILE.SIZE+1,this.scrollEdgeX=0,this.scrollEdgeY=0,this.gameWidthRatio=0,this.gameHeightRatio=0,this.maxScrollX=0,this.maxScrollY=0}return t.prototype.scroll=function(t){this.scrollX+=t.dx,this.scrollY+=t.dy,this.scrollX<0&&(this.scrollX=0),this.scrollY<0&&(this.scrollY=0),this.scrollX>this.maxScrollX&&(this.scrollX=this.maxScrollX),this.scrollY>this.maxScrollY&&(this.scrollY=this.maxScrollY)},t.prototype.setResolution=function(t){this.resolution=t,this.aspectRatio=this.resolution.width/this.resolution.height},t.prototype.updateProperties=function(t){this.gameScreenWidth=this.resolution.width/this.zoom,this.gameScreenHeight=this.resolution.height/this.zoom,this.scrollEdgeX=this.gameScreenWidth-r.DISPLAY.SCROLL.BORDER,this.scrollEdgeY=this.gameScreenHeight-r.DISPLAY.SCROLL.BORDER,this.initRangeX=this.gameScreenWidth/r.GAME.TILE.SIZE+1,this.initRangeY=this.gameScreenHeight/r.GAME.TILE.SIZE+1,this.maxScrollX=1+this.maxMapX-this.gameScreenWidth,this.maxScrollY=1+this.maxMapY-this.gameScreenHeight,this.gameWidthRatio=this.gameScreenWidth/t.width,this.gameHeightRatio=this.gameScreenHeight/t.height},t.prototype.setZoom=function(t){this.zoom=t,this.updateProperties(this.game.canvasBoundingRect),this.scroll({dx:0,dy:0}),this.game.rendererManager.setUboWorldTransforms(this.gameScreenWidth,this.gameScreenHeight)},t.prototype.zoomIn=function(t,e){var i=this.zoom,r=Math.min(this.maxZoom,1.1*i);this.scrollX=this.scrollX+t/i-t/r,this.scrollY=this.scrollY+e/i-e/r,this.zoom=r,this.updateProperties(this.game.canvasBoundingRect),this.scroll({dx:0,dy:0}),this.game.rendererManager.setUboWorldTransforms(this.gameScreenWidth,this.gameScreenHeight)},t.prototype.zoomOut=function(t,e){var i=this.zoom,r=Math.max(this.minZoom,i/1.1);this.scrollX=this.scrollX+t/i-t/r,this.scrollY=this.scrollY+e/i-e/r,this.zoom=r,this.updateProperties(this.game.canvasBoundingRect),this.scroll({dx:0,dy:0}),this.game.rendererManager.setUboWorldTransforms(this.gameScreenWidth,this.gameScreenHeight)},t}(),v=function(){function t(t,e,i){this.tickAccumulator=0,this.currentTick=0,this.animAccumulator=0,this.currentAnim=0,this.lastTime=0,this.fps=0,this.fpsLastTime=0,this.timePerTick=1e3/t,this.timerTriggerAccum=3*this.timePerTick,this.timePerAnim=1e3/e,this.fpsInterval=i}return t.prototype.update=function(t){var e=t-this.lastTime;return this.lastTime=t,this.tickAccumulator+=e,this.animAccumulator+=e,e},t.prototype.shouldAnimUpdate=function(){return this.animAccumulator>=this.timePerAnim&&(this.animAccumulator-=this.timePerAnim,this.currentAnim++,!0)},t.prototype.shouldTickUpdate=function(){return this.tickAccumulator>=this.timePerTick&&(this.tickAccumulator-=this.timePerTick,this.currentTick++,!0)},t.prototype.updateFps=function(t,e){t-this.fpsLastTime>this.fpsInterval&&(this.fps=Math.round(1e3/e),this.fpsLastTime=t)},t.prototype.getInterpolation=function(){return this.tickAccumulator/this.timePerTick},t.prototype.needCatchUp=function(t){var e=t-this.lastTime;return!(this.tickAccumulator+e<this.timerTriggerAccum)},t}();function A(t){return new Promise((function(e,i){var r=new Image;r.onload=function(){return e(r)},r.src=t}))}function y(t){var e,i,r,s,n,a,o=window.devicePixelRatio;return t.devicePixelContentBoxSize?(n=(e=[t.devicePixelContentBoxSize[0].inlineSize,t.devicePixelContentBoxSize[0].blockSize])[0],a=e[1],o=1):t.contentBoxSize?t.contentBoxSize[0]?(n=(i=[t.contentBoxSize[0].inlineSize,t.contentBoxSize[0].blockSize])[0],a=i[1]):(n=(r=[t.contentBoxSize.inlineSize,t.contentBoxSize.blockSize])[0],a=r[1]):(n=(s=[t.contentRect.width,t.contentRect.height])[0],a=s[1]),{width:Math.round(n*o),height:Math.round(a*o)}}var M=function(){function t(t,e,i){this.lastDisplayWidth=0,this.lastDisplayHeight=0,this.gamemap=[],this.gameMapChanged=!1,this.started=!1,this.gameAction=0,this.selectAnim=[{x:0,y:0,orientation:0,frameIndex:0,active:!1}],this.lastScrollX=-1,this.lastScrollY=-1,this.lastScreenX=-1,this.lastScreenY=-1,this.startGameHandler=this.startGame.bind(this),this.handleContextMenu=function(t){return t.preventDefault()},this.canvasElement=document.createElement("canvas"),document.body.appendChild(this.canvasElement),this.canvasBoundingRect=this.canvasElement.getBoundingClientRect();var s=this.canvasElement.getContext("webgl2");if(!s)throw new Error("WebGL2 not supported in this browser");this.gl=s,this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,0),this.canvasElement.addEventListener("contextmenu",this.handleContextMenu);var n,a,o=(n=this.handleCanvasResize.bind(this),function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];a&&clearTimeout(a),a=window.setTimeout((function(){return n.apply(void 0,t)}),250)});this.resizeObserver=new ResizeObserver(o),this.resizeObserver.observe(this.canvasElement,{box:"content-box"}),this.timeManager=new v(r.GAME.TIMING.TICK_RATE,r.GAME.TIMING.ANIM_RATE,r.GAME.TIMING.FPS_UPDATE_INTERVAL),this.cameraManager=new E(this),this.rendererManager=new d(this.gl,e,t,i),this.inputManager=new g(this),this.resizeCanvasToDisplaySize(this.canvasElement),this.uiManager=new m(this),this.uiManager.mainMenu(),this.uiManager.getStartButtonElement().addEventListener("click",this.startGameHandler)}return t.prototype.dispose=function(){this.rendererManager.dispose(),this.canvasElement.removeEventListener("contextmenu",this.handleContextMenu),this.uiManager.getStartButtonElement().removeEventListener("click",this.startGameHandler),this.resizeObserver.unobserve(this.canvasElement),this.resizeObserver.disconnect(),this.inputManager.dispose()},t.prototype.handleCanvasResize=function(t){for(var e=0,i=t;e<i.length;e++){var r=y(i[e]),s=r.width,n=r.height;this.lastDisplayWidth=s,this.lastDisplayHeight=n,this.canvasBoundingRect=this.canvasElement.getBoundingClientRect(),this.cameraManager.updateProperties(this.canvasBoundingRect)}},t.prototype.resizeCanvasToDisplaySize=function(t){var e=this.lastDisplayWidth,i=this.lastDisplayHeight,r=t.width!==e||t.height!==i;return r&&(t.width=e,t.height=i,this.gl.viewport(0,0,t.width,t.height),this.rendererManager&&this.rendererManager.worldBuffer&&this.rendererManager.setUboWorldTransforms(this.cameraManager.gameScreenWidth,this.cameraManager.gameScreenHeight)),r},t.prototype.startGame=function(){var t=this;this.cameraManager.setResolution(r.DISPLAY.RESOLUTIONS[this.uiManager.getResolutionSelectElement().selectedIndex]),this.cameraManager.updateProperties(this.canvasBoundingRect),this.rendererManager.setUboWorldTransforms(this.cameraManager.gameScreenWidth,this.cameraManager.gameScreenHeight),this.uiManager.setCursor("cur-pointer"),this.inputManager.init(),this.uiManager.getStartButtonElement().style.display="none",this.uiManager.getResolutionSelectElement().style.display="none",this.initGameStates(),this.started=!0,this.timeManager.lastTime=performance.now(),setInterval((function(){t.checkUpdate()}),500),this.loop(0)},t.prototype.initGameStates=function(){this.entities=new f(100),this.entityBehaviors=new p(this);var t=this.entities.spawn();t.type=i.ALIEN,t.hitPoints=100,t.x=1100,t.y=1100,t.frameIndex=33,t.orientation=6;var e=this.entities.spawn();e.type=i.ALIEN,e.hitPoints=100,e.x=0,e.y=0,e.frameIndex=212,e.orientation=5;var s=this.entities.spawn();s.type=i.ALIEN,s.hitPoints=100,s.x=455,s.y=455,s.frameIndex=122,s.orientation=14,this.gamemap=[];for(var n=0;n<r.GAME.MAP.WIDTH*r.GAME.MAP.HEIGHT;n++)this.gamemap.push(Math.floor(16*Math.random()))},t.prototype.procGame=function(){if(this.gameAction)switch(this.gameAction){case r.GAME.ACTIONS.DEFAULT:this.defaultAction();break;case r.GAME.ACTIONS.RELEASESEL:this.selectUnits()}this.gameAction=0,this.inputManager.processInputs()},t.prototype.update=function(t,e){var i=this.timeManager.update(t);if(this.procGame(),this.timeManager.shouldAnimUpdate()&&this.uiManager.animateCursor(),this.timeManager.shouldTickUpdate()&&this.tick(),!e){this.resizeCanvasToDisplaySize(this.canvasElement);var s=[];if(this.gameMapChanged||this.cameraManager.scrollX!==this.lastScrollX||this.cameraManager.scrollY!==this.lastScrollY||this.cameraManager.gameScreenWidth!==this.lastScreenX||this.cameraManager.gameScreenHeight!==this.lastScreenY){this.lastScreenX=this.cameraManager.gameScreenWidth,this.lastScreenY=this.cameraManager.gameScreenHeight,this.lastScrollX=this.cameraManager.scrollX,this.lastScrollY=this.cameraManager.scrollY,this.gameMapChanged=!1;var n=r.GAME.TILE.SIZE,a=Math.floor(this.lastScrollX/n),o=Math.floor(this.lastScrollY/n),h=this.lastScreenX/n+1,l=this.lastScreenY/n+1;this.lastScrollX%n>n-this.lastScreenX%n&&(h+=1),this.lastScrollY%n>n-this.lastScreenY%n&&(l+=1);for(var u=0;u<l;u++)for(var c=0;c<h;c++){var d=this.gamemap[a+c+(o+u)*r.GAME.MAP.WIDTH];s.push([c*n-this.lastScrollX%n,u*n-this.lastScrollY%n,d])}}var m=[];if(this.inputManager.isSelecting){var g=Math.min(this.inputManager.selX,this.inputManager.mouseX),p=Math.max(this.inputManager.selX,this.inputManager.mouseX),f=Math.min(this.inputManager.selY,this.inputManager.mouseY),E=Math.max(this.inputManager.selY,this.inputManager.mouseY),v=2/this.cameraManager.zoom;m.push({x:g,y:f,width:p-g,height:v,r:0,g:1,b:0,a:1},{x:g,y:E,width:p-g,height:v,r:0,g:1,b:0,a:1},{x:g,y:f,width:v,height:E-f,r:0,g:1,b:0,a:1},{x:p,y:f,width:v,height:E-f,r:0,g:1,b:0,a:1})}if(this.uiManager.isMapEditorVisible()){v=2/this.cameraManager.zoom,n=r.GAME.TILE.SIZE;for(var A=0;A<=r.GAME.MAP.HEIGHT;A++){var y=A*n-this.lastScrollY%n;m.push({x:0,y,width:this.lastScreenX,height:v,r:1,g:1,b:1,a:1})}for(var M=0;M<=r.GAME.MAP.WIDTH;M++){var T=M*n-this.lastScrollX%n;m.push({x:T,y:0,width:v,height:this.lastScreenY,r:1,g:1,b:1,a:1})}a=Math.floor(this.cameraManager.scrollX/n),o=Math.floor(this.cameraManager.scrollY/n),c=Math.floor((this.inputManager.mouseX+this.cameraManager.scrollX)/n)-a,u=Math.floor((this.inputManager.mouseY+this.cameraManager.scrollY)/n)-o,r.GAME.MAP.WIDTH,m.push({x:c*n-this.lastScrollX%n,y:u*n-this.lastScrollY%n,width:n,height:n,r:1,g:1,b:1,a:.2})}var S=[];this.uiManager.widgetAnim>0&&S.push([this.uiManager.widgetAnimX-this.cameraManager.scrollX,this.uiManager.widgetAnimY-this.cameraManager.scrollY,this.uiManager.widgetAnim+3,r.GAME.WIDGETS.SIZE/this.cameraManager.zoom]),this.rendererManager.render(s,this.entities.pool,m,S,this.cameraManager,this.timeManager.getInterpolation())}this.timeManager.updateFps(t,i)},t.prototype.checkUpdate=function(){var t=performance.now();this.timeManager.needCatchUp(t)&&this.update(t,!0)},t.prototype.tick=function(){for(var t,e=0,i=0;e<this.entities.active||i<this.entities.total;i++)(t=this.entities.pool[i]).active&&(e+=1,this.entityBehaviors.process(t))},t.prototype.loop=function(t){this.update(t),requestAnimationFrame(this.loop.bind(this))},t.prototype.defaultAction=function(){var t=this.inputManager.gamePosition;this.uiManager.widgetAnim=1,this.uiManager.widgetAnimX=t.x-32/this.cameraManager.zoom,this.uiManager.widgetAnimY=t.y-32/this.cameraManager.zoom},t.prototype.selectUnits=function(){var t=this.inputManager.selectionStart,e=this.inputManager.selectionEnd;console.log("select",t.x,t.y,e.x,e.y)},t.prototype.setTileAt=function(t,e,i){var s=r.GAME.TILE.SIZE,n=Math.floor(t/s),a=Math.floor(e/s),o=n+a*r.GAME.MAP.WIDTH;o<0||o>=this.gamemap.length?console.warn("Tile position out of bounds: (".concat(n,", ").concat(a,")")):(this.gamemap[o]=i,this.gameMapChanged=!0)},t.prototype.sampleTileAt=function(t,e){var i=r.GAME.TILE.SIZE,s=Math.floor(t/i),n=Math.floor(e/i),a=s+n*r.GAME.MAP.WIDTH;if(a<0||a>=this.gamemap.length)console.warn("Tile position out of bounds: (".concat(s,", ").concat(n,")"));else{var o=this.gamemap[a];this.uiManager.setTileSelectIndex(o)}},t.prototype.saveMap=function(t,e){t||(t=this.gamemap),e||(e="map_".concat(r.GAME.MAP.WIDTH,"_").concat(r.GAME.MAP.HEIGHT,".json"));var i=JSON.stringify(t,null,2),s=new Blob([i],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(s),n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n)},t.prototype.openMap=function(t){this.gamemap=t,this.gameMapChanged=!0},t.prototype.saveEntities=function(){},t.prototype.openEntities=function(){},t.prototype.saveAnimationList=function(){},t.prototype.openAnimationList=function(){},t}();document.addEventListener("DOMContentLoaded",(function(t){var e=document.createElement("div");e.classList.add("loading-text"),e.textContent="Loading...",document.body.appendChild(e);var i=A("images/alien.png"),r=A("images/map-tiles-vertical.png"),s=A("images/animated-widget.png");Promise.all([i,r,s]).then((function(t){document.body.removeChild(e),window.game?console.error("Game instance already started"):(window.game=new M(t[0],t[1],t[2]),window.addEventListener("unload",(function(){window.game.dispose()})))}))}))})();